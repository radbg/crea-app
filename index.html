<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>crea - Brainstorming colaborativo</title>
    
    <!-- Favicon SVG -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg width='192' height='192' viewBox='0 0 192 192' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='bgIcon2' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea'/%3E%3Cstop offset='100%25' style='stop-color:%23764ba2'/%3E%3C/linearGradient%3E%3ClinearGradient id='flameO2' x1='0%25' y1='100%25' x2='0%25' y2='0%25'%3E%3Cstop offset='0%25' style='stop-color:%23fda085'/%3E%3Cstop offset='50%25' style='stop-color:%23f6d365'/%3E%3Cstop offset='100%25' style='stop-color:%23fff5cc'/%3E%3C/linearGradient%3E%3ClinearGradient id='flameI2' x1='0%25' y1='100%25' x2='0%25' y2='0%25'%3E%3Cstop offset='0%25' style='stop-color:%23f6d365'/%3E%3Cstop offset='100%25' style='stop-color:%23fff'/%3E%3C/linearGradient%3E%3CradialGradient id='flameG2'%3E%3Cstop offset='0%25' style='stop-color:%23f6d365;stop-opacity:0.6'/%3E%3Cstop offset='100%25' style='stop-color:%23fda085;stop-opacity:0'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='192' height='192' rx='42' fill='url(%23bgIcon2)'/%3E%3Cellipse cx='96' cy='96' rx='65' ry='75' fill='url(%23flameG2)' opacity='0.4'/%3E%3Cg transform='translate(96, 96)'%3E%3Cpath d='M 0,-60 Q -17,-55 -25,-44 Q -31,-32 -31,-17 Q -31,0 -22,13 Q -11,22 0,24 Q 11,22 22,13 Q 31,0 31,-17 Q 31,-32 25,-44 Q 17,-55 0,-60 Z' fill='url(%23flameO2)'/%3E%3Cpath d='M 0,-52 Q -13,-48 -19,-38 Q -23,-27 -23,-13 Q -23,0 -16,11 Q -8,18 0,19 Q 8,18 16,11 Q 23,0 23,-13 Q 23,-27 19,-38 Q 13,-48 0,-52 Z' fill='url(%23flameI2)' opacity='0.9'/%3E%3Cpath d='M 0,-38 Q -9,-35 -12,-27 Q -14,-20 -14,-11 Q -14,0 -10,8 Q -4,12 0,13 Q 4,12 10,8 Q 14,0 14,-11 Q 14,-20 12,-27 Q 9,-35 0,-38 Z' fill='%23fff' opacity='0.85'/%3E%3Cellipse cx='0' cy='-17' rx='4.5' ry='9' fill='%23fff' opacity='0.9'/%3E%3Ccircle cx='-2' cy='-21' r='2.2' fill='%23fff'/%3E%3C/g%3E%3C/svg%3E">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg width='180' height='180' viewBox='0 0 180 180' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea'/%3E%3Cstop offset='100%25' style='stop-color:%23764ba2'/%3E%3C/linearGradient%3E%3ClinearGradient id='flame' x1='0%25' y1='100%25' x2='0%25' y2='0%25'%3E%3Cstop offset='0%25' style='stop-color:%23fda085'/%3E%3Cstop offset='50%25' style='stop-color:%23f6d365'/%3E%3Cstop offset='100%25' style='stop-color:%23fff5cc'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='180' height='180' rx='40' fill='url(%23bg)'/%3E%3Cg transform='translate(90, 90)'%3E%3Cpath d='M 0,-60 Q -17,-55 -25,-44 Q -31,-32 -31,-17 Q -31,0 -22,13 Q -11,22 0,24 Q 11,22 22,13 Q 31,0 31,-17 Q 31,-32 25,-44 Q 17,-55 0,-60 Z' fill='url(%23flame)'/%3E%3Cpath d='M 0,-38 Q -9,-35 -12,-27 Q -14,-20 -14,-11 Q -14,0 -10,8 Q -4,12 0,13 Q 4,12 10,8 Q 14,0 14,-11 Q 14,-20 12,-27 Q 9,-35 0,-38 Z' fill='%23fff' opacity='0.85'/%3E%3C/g%3E%3C/svg%3E">
    
    <!-- Meta tags -->
    <meta name="description" content="Crea - Aplicaci√≥n de brainstorming colaborativo para equipos creativos">
    <meta name="theme-color" content="#667eea">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF para exportar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- PapaParse para exportar CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .bounce-animation {
            animation: bounce 2s infinite;
        }

        /* Hacer que inputs y textareas sean m√°s grandes en m√≥vil */
        @media (max-width: 768px) {
            input, textarea, select {
                font-size: 16px !important; /* Evita zoom en iOS */
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCYeW5sGLGFmrOXNi4a4ukoxGhD8JM96jw",
            authDomain: "crea-35de1.firebaseapp.com",
            projectId: "crea-35de1",
            storageBucket: "crea-35de1.firebasestorage.app",
            messagingSenderId: "387856530202",
            appId: "1:387856530202:web:f7caff5e9020e3d927caa3"
        };

        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        const CHAR_LIMIT = 280;
        const COMMENT_LIMIT = 120;

        const ESTADOS = {
            INCUBANDO: 'incubando',
            ACTIVA: 'activa',
            REALIZADA: 'realizada',
            RECHAZADA: 'rechazada',
            EXPIRADA: 'expirada',
            ELIMINADA: 'eliminada'
        };

        const ROLES = {
            OWNER: 'owner',
            EDITOR: 'editor',
            COMENTADOR: 'comentador',
            LECTOR: 'lector'
        };

        const VISIBILIDAD = {
            PRIVADA: 'privada',
            PUBLICA: 'publica'
        };

        const AUDIENCIA = {
            TODO_PUBLICO: 'todo_publico',
            SOLO_AMIGOS: 'solo_amigos'
        };

        const NIVEL_INTERACCION = {
            SOLO_LECTURA: 'solo_lectura',
            COMENTARIOS_REACCIONES: 'comentarios_reacciones',
            FULL_INTERACCION: 'full_interaccion'
        };

        const ESTADO_AMISTAD = {
            PENDIENTE: 'pendiente',
            ACEPTADA: 'aceptada',
            RECHAZADA: 'rechazada'
        };

        const reaccionesDisponibles = ['üí°', 'üî•', '‚ù§Ô∏è', 'üëç', 'ü§î', '‚≠ê', 'üöÄ', 'üí≠'];

        // Desaf√≠os creativos
        const DESAFIOS = [
            {
                id: 1,
                titulo: "Curr√≠culum Absurdo",
                descripcion: "Crea un curr√≠culum para un personaje ficticio con experiencia laboral completamente rid√≠cula",
                ejemplo: "Chef de Nubes en F√°brica del Cielo (2020-2023): Responsable de darle forma a las nubes para que parezcan animales"
            },
            {
                id: 2,
                titulo: "Agrega la Premisa",
                descripcion: "Toma una historia conocida y agr√©gale una premisa absurda al inicio",
                ejemplo: "Romeo y Julieta, pero Romeo es al√©rgico a las personas llamadas Julieta"
            },
            {
                id: 3,
                titulo: "Animal Imposible",
                descripcion: "Inventa un animal que no podr√≠a existir en la realidad y describe sus caracter√≠sticas",
                ejemplo: "El Elefante Transparente: Solo es visible cuando nadie lo est√° mirando"
            },
            {
                id: 4,
                titulo: "Objeto Quejumbroso",
                descripcion: "Escribe un mon√≥logo desde la perspectiva de un objeto cotidiano que se queja de su existencia",
                ejemplo: "Un calcet√≠n lament√°ndose de que siempre pierde a su pareja en la lavadora"
            },
            {
                id: 5,
                titulo: "Excusa Creativa",
                descripcion: "Inventa la excusa m√°s elaborada y absurda para llegar tarde al trabajo",
                ejemplo: "Un pulpo me rob√≥ las llaves del coche y tuve que negociar con √©l durante 3 horas"
            },
            {
                id: 6,
                titulo: "Ducha √âpica",
                descripcion: "Convierte una actividad mundana en una aventura √©pica al estilo pel√≠cula de acci√≥n",
                ejemplo: "Describe ducharte como si fueras un h√©roe desarmando una bomba"
            },
            {
                id: 7,
                titulo: "Perfume Absurdo",
                descripcion: "Crea un perfume con un nombre y descripci√≥n completamente rid√≠culos",
                ejemplo: "Eau de Calcet√≠n Mojado: El aroma que nadie pidi√≥ pero todos recordar√°n"
            },
            {
                id: 8,
                titulo: "D√≠a sin Electricidad",
                descripcion: "Imagina c√≥mo ser√≠a tu d√≠a si de repente toda la electricidad desapareciera permanentemente",
                ejemplo: "Tendr√≠a que entrenar palomas mensajeras para enviar emails"
            },
            {
                id: 9,
                titulo: "Pelea con tu IA",
                descripcion: "Escribe un di√°logo donde discutes con tu asistente de IA sobre algo rid√≠culo",
                ejemplo: "Convencer a la IA de que las pizza con pi√±a es superior"
            },
            {
                id: 10,
                titulo: "Carta de Amor con Twist",
                descripcion: "Escribe una carta de amor rom√°ntica, pero el objeto de tu amor es algo inesperado",
                ejemplo: "Una carta de amor apasionada dirigida a tu WiFi"
            }
        ];

        function App() {
            const [usuario, setUsuario] = useState(null);
            const [cargando, setCargando] = useState(true);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // Usuario autenticado
                        const userDoc = await db.collection('usuarios').doc(user.uid).get();
                        if (userDoc.exists) {
                            setUsuario({ uid: user.uid, ...userDoc.data(), emailVerified: user.emailVerified });
                        } else {
                            // Crear documento de usuario si no existe
                            await db.collection('usuarios').doc(user.uid).set({
                                email: user.email,
                                nombre: user.displayName || user.email.split('@')[0],
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            setUsuario({ 
                                uid: user.uid, 
                                email: user.email, 
                                nombre: user.displayName || user.email.split('@')[0],
                                emailVerified: user.emailVerified
                            });
                        }
                    } else {
                        setUsuario(null);
                    }
                    setCargando(false);
                });

                return () => unsubscribe();
            }, []);

            if (cargando) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center">
                        <div className="text-white text-2xl font-bold">Cargando...</div>
                    </div>
                );
            }

            if (!usuario) {
                return <Auth />;
            }

            if (!usuario.emailVerified) {
                return <VerificarEmail usuario={usuario} />;
            }

            return <MainApp usuario={usuario} />;
        }

        // Componente de Autenticaci√≥n
        function Auth() {
            const [modo, setModo] = useState('login'); // 'login', 'registro', 'recuperar'
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [nombre, setNombre] = useState('');
            const [aceptaTerminos, setAceptaTerminos] = useState(false);
            const [error, setError] = useState('');
            const [exito, setExito] = useState('');
            const [cargando, setCargando] = useState(false);
            const [mostrarReenviarVerificacion, setMostrarReenviarVerificacion] = useState(false);
            const [usuarioNoVerificado, setUsuarioNoVerificado] = useState(null);

            async function handleLogin(e) {
                e.preventDefault();
                setError('');
                setMostrarReenviarVerificacion(false);
                setCargando(true);

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    // Ya no verificamos el email - login directo
                } catch (err) {
                    if (err.code === 'auth/user-not-found') {
                        setError('No existe una cuenta con este email');
                    } else if (err.code === 'auth/wrong-password') {
                        setError('Contrase√±a incorrecta');
                    } else {
                        setError('Error al iniciar sesi√≥n: ' + err.message);
                    }
                }
                setCargando(false);
            }

            async function reenviarVerificacion() {
                setCargando(true);
                setError('');
                setExito('');
                
                try {
                    // Necesitamos volver a autenticar al usuario temporalmente
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    
                    const actionCodeSettings = {
                        url: 'https://radbg.github.io/crea-app/',
                        handleCodeInApp: false
                    };
                    
                    await userCredential.user.sendEmailVerification(actionCodeSettings);
                    await auth.signOut();
                    
                    setExito('‚úÖ Email de verificaci√≥n reenviado. Revisa tu bandeja de entrada (y spam).');
                    setMostrarReenviarVerificacion(false);
                } catch (err) {
                    setError('Error al reenviar email: ' + err.message);
                }
                
                setCargando(false);
            }

            async function handleRegistro(e) {
                e.preventDefault();
                setError('');
                
                if (!aceptaTerminos) {
                    setError('Debes aceptar los T√©rminos de Uso y Pol√≠tica de Privacidad');
                    return;
                }
                
                setCargando(true);

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    
                    // Actualizar perfil con nombre
                    await userCredential.user.updateProfile({
                        displayName: nombre
                    });

                    // Crear documento en Firestore
                    await db.collection('usuarios').doc(userCredential.user.uid).set({
                        nombre: nombre,
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Crear salas por defecto
                    const salasDefecto = [
                        { 
                            nombre: 'Trabajo', 
                            color: 'blue',
                            creadorId: userCredential.user.uid,
                            miembros: {
                                [userCredential.user.uid]: ROLES.OWNER
                            },
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        },
                        { 
                            nombre: 'Personal', 
                            color: 'green',
                            creadorId: userCredential.user.uid,
                            miembros: {
                                [userCredential.user.uid]: ROLES.OWNER
                            },
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        },
                        { 
                            nombre: 'Proyectos', 
                            color: 'purple',
                            creadorId: userCredential.user.uid,
                            miembros: {
                                [userCredential.user.uid]: ROLES.OWNER
                            },
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    ];

                    for (const sala of salasDefecto) {
                        await db.collection('salas').add(sala);
                    }

                    // Ya no se env√≠a email de verificaci√≥n
                    // La cuenta est√° lista para usar inmediatamente
                    setExito('¬°Cuenta creada exitosamente! Redirigiendo...');
                    
                    // Redirigir a la app despu√©s de 1 segundo
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } catch (err) {
                    if (err.code === 'auth/email-already-in-use') {
                        setError('Este email ya est√° registrado');
                    } else if (err.code === 'auth/weak-password') {
                        setError('La contrase√±a debe tener al menos 6 caracteres');
                    } else {
                        setError('Error al crear cuenta: ' + err.message);
                    }
                }
                setCargando(false);
            }

            async function handleRecuperar(e) {
                e.preventDefault();
                setError('');
                setExito('');
                setCargando(true);

                try {
                    await auth.sendPasswordResetEmail(email);
                    setExito('¬°Email enviado! Revisa tu bandeja de entrada para restablecer tu contrase√±a.');
                } catch (err) {
                    if (err.code === 'auth/user-not-found') {
                        setError('No existe una cuenta con este email');
                    } else {
                        setError('Error: ' + err.message);
                    }
                }
                setCargando(false);
            }

            if (modo === 'registro') {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
                            <div className="text-center mb-8">
                                {/* Logo de llama */}
                                <div className="flex justify-center mb-4">
                                    <svg width="64" height="64" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg">
                                        <defs>
                                            <linearGradient id="flameAuth1" x1="0%" y1="100%" x2="0%" y2="0%">
                                                <stop offset="0%" style={{stopColor:"#fda085"}}/>
                                                <stop offset="50%" style={{stopColor:"#f6d365"}}/>
                                                <stop offset="100%" style={{stopColor:"#fff5cc"}}/>
                                            </linearGradient>
                                            <linearGradient id="flameAuth2" x1="0%" y1="100%" x2="0%" y2="0%">
                                                <stop offset="0%" style={{stopColor:"#f6d365"}}/>
                                                <stop offset="100%" style={{stopColor:"#fff"}}/>
                                            </linearGradient>
                                        </defs>
                                        <g transform="translate(96, 96)">
                                            <path d="M 0,-60 Q -17,-55 -25,-44 Q -31,-32 -31,-17 Q -31,0 -22,13 Q -11,22 0,24 Q 11,22 22,13 Q 31,0 31,-17 Q 31,-32 25,-44 Q 17,-55 0,-60 Z" fill="url(#flameAuth1)"/>
                                            <path d="M 0,-52 Q -13,-48 -19,-38 Q -23,-27 -23,-13 Q -23,0 -16,11 Q -8,18 0,19 Q 8,18 16,11 Q 23,0 23,-13 Q 23,-27 19,-38 Q 13,-48 0,-52 Z" fill="url(#flameAuth2)" opacity="0.9"/>
                                            <path d="M 0,-38 Q -9,-35 -12,-27 Q -14,-20 -14,-11 Q -14,0 -10,8 Q -4,12 0,13 Q 4,12 10,8 Q 14,0 14,-11 Q 14,-20 12,-27 Q 9,-35 0,-38 Z" fill="#fff" opacity="0.85"/>
                                        </g>
                                    </svg>
                                </div>
                                <h1 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-2">
                                    crea
                                </h1>
                                <p className="text-gray-600">Crear cuenta nueva</p>
                            </div>

                            {error && (
                                <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                                    <p className="text-red-700 text-sm">{error}</p>
                                </div>
                            )}

                            {exito && (
                                <div className="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                                    <p className="text-green-700 text-sm">{exito}</p>
                                </div>
                            )}

                            <form onSubmit={handleRegistro} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Nombre
                                    </label>
                                    <input
                                        type="text"
                                        value={nombre}
                                        onChange={(e) => setNombre(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Email
                                    </label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Contrase√±a
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        minLength="6"
                                        required
                                    />
                                    <p className="text-xs text-gray-500 mt-1">M√≠nimo 6 caracteres</p>
                                </div>
                                
                                {/* Checkbox de aceptaci√≥n de t√©rminos */}
                                <div className="flex items-start gap-2 pt-2">
                                    <input
                                        type="checkbox"
                                        id="aceptaTerminos"
                                        checked={aceptaTerminos}
                                        onChange={(e) => setAceptaTerminos(e.target.checked)}
                                        className="mt-1 w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"
                                        required
                                    />
                                    <label htmlFor="aceptaTerminos" className="text-xs text-gray-600 leading-relaxed">
                                        Acepto los{' '}
                                        <a 
                                            href="terminos.html" 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            className="text-purple-600 hover:underline font-medium"
                                        >
                                            T√©rminos de Uso
                                        </a>
                                        {' '}y la{' '}
                                        <a 
                                            href="privacidad.html" 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            className="text-purple-600 hover:underline font-medium"
                                        >
                                            Pol√≠tica de Privacidad
                                        </a>
                                    </label>
                                </div>
                                
                                <button
                                    type="submit"
                                    disabled={cargando}
                                    className="w-full gradient-bg text-white py-3 rounded-lg font-medium hover:opacity-90 transition-opacity disabled:opacity-50"
                                >
                                    {cargando ? 'Creando cuenta...' : 'Crear Cuenta'}
                                </button>
                            </form>

                            <p className="text-center text-sm text-gray-600 mt-4">
                                ¬øYa tienes cuenta?{' '}
                                <button
                                    onClick={() => setModo('login')}
                                    className="text-purple-600 font-medium hover:underline"
                                >
                                    Inicia sesi√≥n
                                </button>
                            </p>
                        </div>
                    </div>
                );
            }

            if (modo === 'recuperar') {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
                            <div className="text-center mb-8">
                                <div className="text-6xl mb-4">üîê</div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">
                                    Recuperar Contrase√±a
                                </h2>
                                <p className="text-gray-600">
                                    Te enviaremos un email para restablecer tu contrase√±a
                                </p>
                            </div>

                            {error && (
                                <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                                    <p className="text-red-700 text-sm">{error}</p>
                                </div>
                            )}

                            {exito && (
                                <div className="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                                    <p className="text-green-700 text-sm">{exito}</p>
                                </div>
                            )}

                            <form onSubmit={handleRecuperar} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Email
                                    </label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        required
                                    />
                                </div>

                                <button
                                    type="submit"
                                    disabled={cargando}
                                    className="w-full gradient-bg text-white py-3 rounded-lg font-medium hover:opacity-90 disabled:opacity-50"
                                >
                                    {cargando ? 'Enviando...' : 'Enviar Email'}
                                </button>

                                <button
                                    type="button"
                                    onClick={() => setModo('login')}
                                    className="w-full text-gray-600 text-sm hover:underline"
                                >
                                    ‚Üê Volver al inicio de sesi√≥n
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            // Modo login
            return (
                <div className="min-h-screen gradient-bg flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
                        <div className="text-center mb-8">
                            {/* Logo de llama */}
                            <div className="flex justify-center mb-4">
                                <svg width="64" height="64" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                        <linearGradient id="flameLogin1" x1="0%" y1="100%" x2="0%" y2="0%">
                                            <stop offset="0%" style={{stopColor:"#fda085"}}/>
                                            <stop offset="50%" style={{stopColor:"#f6d365"}}/>
                                            <stop offset="100%" style={{stopColor:"#fff5cc"}}/>
                                        </linearGradient>
                                        <linearGradient id="flameLogin2" x1="0%" y1="100%" x2="0%" y2="0%">
                                            <stop offset="0%" style={{stopColor:"#f6d365"}}/>
                                            <stop offset="100%" style={{stopColor:"#fff"}}/>
                                        </linearGradient>
                                    </defs>
                                    <g transform="translate(96, 96)">
                                        <path d="M 0,-60 Q -17,-55 -25,-44 Q -31,-32 -31,-17 Q -31,0 -22,13 Q -11,22 0,24 Q 11,22 22,13 Q 31,0 31,-17 Q 31,-32 25,-44 Q 17,-55 0,-60 Z" fill="url(#flameLogin1)"/>
                                        <path d="M 0,-52 Q -13,-48 -19,-38 Q -23,-27 -23,-13 Q -23,0 -16,11 Q -8,18 0,19 Q 8,18 16,11 Q 23,0 23,-13 Q 23,-27 19,-38 Q 13,-48 0,-52 Z" fill="url(#flameLogin2)" opacity="0.9"/>
                                        <path d="M 0,-38 Q -9,-35 -12,-27 Q -14,-20 -14,-11 Q -14,0 -10,8 Q -4,12 0,13 Q 4,12 10,8 Q 14,0 14,-11 Q 14,-20 12,-27 Q 9,-35 0,-38 Z" fill="#fff" opacity="0.85"/>
                                    </g>
                                </svg>
                            </div>
                            <h1 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-2">
                                crea
                            </h1>
                            <p className="text-gray-600">Colaboraci√≥n creativa en equipo</p>
                        </div>

                        {error && (
                            <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                                <p className="text-red-700 text-sm">{error}</p>
                            </div>
                        )}

                        {exito && (
                            <div className="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                                <p className="text-green-700 text-sm">{exito}</p>
                            </div>
                        )}

                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Email
                                </label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Contrase√±a
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    required
                                />
                            </div>
                            
                            <button
                                type="button"
                                onClick={() => setModo('recuperar')}
                                className="text-sm text-purple-600 hover:underline"
                            >
                                ¬øOlvidaste tu contrase√±a?
                            </button>

                            <button
                                type="submit"
                                disabled={cargando}
                                className="w-full gradient-bg text-white py-3 rounded-lg font-medium hover:opacity-90 transition-opacity disabled:opacity-50"
                            >
                                {cargando ? 'Iniciando sesi√≥n...' : 'Iniciar Sesi√≥n'}
                            </button>
                        </form>

                        <p className="text-center text-sm text-gray-600 mt-4">
                            ¬øNo tienes cuenta?{' '}
                            <button
                                onClick={() => setModo('registro')}
                                className="text-purple-600 font-medium hover:underline"
                            >
                                Reg√≠strate
                            </button>
                        </p>
                    </div>
                </div>
            );
        }

        // Componente de Verificaci√≥n de Email
        function VerificarEmail({ usuario }) {
            const [enviando, setEnviando] = useState(false);
            const [mensaje, setMensaje] = useState('');

            async function reenviarEmail() {
                setEnviando(true);
                setMensaje('');
                try {
                    await auth.currentUser.sendEmailVerification();
                    setMensaje('‚úÖ Email enviado. Revisa tu bandeja de entrada.');
                } catch (err) {
                    setMensaje('‚ùå Error al enviar email: ' + err.message);
                }
                setEnviando(false);
            }

            async function verificarYRecargar() {
                await auth.currentUser.reload();
                if (auth.currentUser.emailVerified) {
                    window.location.reload();
                } else {
                    setMensaje('‚ö†Ô∏è A√∫n no has verificado tu email. Revisa tu bandeja de entrada.');
                }
            }

            return (
                <div className="min-h-screen gradient-bg flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in text-center">
                        <div className="text-6xl mb-4">üìß</div>
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">
                            Verifica tu Email
                        </h2>
                        <p className="text-gray-600 mb-6">
                            Te hemos enviado un email de verificaci√≥n a:<br/>
                            <strong>{usuario.email}</strong>
                        </p>

                        <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 text-left">
                            <p className="text-blue-800 text-sm">
                                <strong>üìã Pasos:</strong>
                            </p>
                            <ol className="text-blue-700 text-sm mt-2 space-y-1 list-decimal list-inside">
                                <li>Abre tu bandeja de entrada</li>
                                <li>Busca el email de Firebase</li>
                                <li>Haz clic en el enlace de verificaci√≥n</li>
                                <li>Vuelve aqu√≠ y haz clic en "Ya verifiqu√©"</li>
                            </ol>
                        </div>

                        {mensaje && (
                            <div className="bg-gray-100 p-3 rounded-lg mb-4 text-sm">
                                {mensaje}
                            </div>
                        )}

                        <div className="space-y-3">
                            <button
                                onClick={verificarYRecargar}
                                className="w-full gradient-bg text-white py-3 rounded-lg font-medium hover:opacity-90"
                            >
                                ‚úì Ya verifiqu√© mi email
                            </button>

                            <button
                                onClick={reenviarEmail}
                                disabled={enviando}
                                className="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300 disabled:opacity-50"
                            >
                                {enviando ? 'Enviando...' : 'üì¨ Reenviar email'}
                            </button>

                            <button
                                onClick={() => auth.signOut()}
                                className="w-full text-gray-600 text-sm hover:underline"
                            >
                                Cerrar sesi√≥n
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // MainApp con Firebase
        function MainApp({ usuario }) {
            const [salas, setSalas] = useState([]);
            const [salaActual, setSalaActual] = useState(null);
            const [ideas, setIdeas] = useState([]);
            const [filtroActivo, setFiltroActivo] = useState('todas');
            const [mostrarModalDesafio, setMostrarModalDesafio] = useState(false);
            const [mostrarPerfil, setMostrarPerfil] = useState(false);
            const [mostrarAnalytics, setMostrarAnalytics] = useState(false);
            const [mostrarModalExportar, setMostrarModalExportar] = useState(false);
            const [desafioActual, setDesafioActual] = useState(null);
            const [mostrarModalCrearSala, setMostrarModalCrearSala] = useState(false);
            const [mostrarModalInvitar, setMostrarModalInvitar] = useState(false);
            const [invitacionesPendientes, setInvitacionesPendientes] = useState([]);
            const [sidebarAbierto, setSidebarAbierto] = useState(false);
            const [mostrarFeedPublico, setMostrarFeedPublico] = useState(false);
            const [salasPublicasDescubiertas, setSalasPublicasDescubiertas] = useState([]);

            // Cargar salas en tiempo real
            useEffect(() => {
                const unsubscribe = db.collection('salas')
                    .where(`miembros.${usuario.uid}`, '!=', null)
                    .onSnapshot((snapshot) => {
                        const salasData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setSalas(salasData);
                        
                        if (salasData.length > 0 && !salaActual) {
                            setSalaActual(salasData[0].id);
                        }
                    });

                return () => unsubscribe();
            }, [usuario.uid]);

            // Cargar ideas en tiempo real
            useEffect(() => {
                if (!salaActual) return;

                const unsubscribe = db.collection('ideas')
                    .where('salaId', '==', salaActual)
                    .onSnapshot((snapshot) => {
                        const ideasData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data(),
                            createdAt: doc.data().createdAt?.toMillis() || Date.now(),
                            expiraAt: doc.data().expiraAt?.toMillis() || Date.now(),
                            eliminadaAt: doc.data().eliminadaAt?.toMillis() || null
                        }));
                        // Ordenar en el cliente
                        ideasData.sort((a, b) => b.createdAt - a.createdAt);
                        setIdeas(ideasData);
                    }, (error) => {
                        console.error('Error al cargar ideas:', error);
                        // Si hay error, mostrar mensaje al usuario
                        if (error.code === 'failed-precondition') {
                            console.log('Necesitas crear un √≠ndice en Firestore. Abre la consola para ver el link.');
                        }
                    });

                return () => unsubscribe();
            }, [salaActual]);

            // Cargar invitaciones pendientes
            useEffect(() => {
                const unsubscribe = db.collection('invitaciones')
                    .where('invitadoId', '==', usuario.uid)
                    .where('estado', '==', 'pendiente')
                    .onSnapshot((snapshot) => {
                        const invitaciones = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setInvitacionesPendientes(invitaciones);
                    });

                return () => unsubscribe();
            }, [usuario.uid]);

            // Cargar salas p√∫blicas descubiertas
            useEffect(() => {
                async function cargarSalasPublicas() {
                    try {
                        // Obtener IDs de amigos
                        const amistades1 = await db.collection('amistades')
                            .where('emisorId', '==', usuario.uid)
                            .where('estado', '==', ESTADO_AMISTAD.ACEPTADA)
                            .get();
                        
                        const amistades2 = await db.collection('amistades')
                            .where('receptorId', '==', usuario.uid)
                            .where('estado', '==', ESTADO_AMISTAD.ACEPTADA)
                            .get();
                        
                        const amigosSet = new Set();
                        amistades1.docs.forEach(doc => amigosSet.add(doc.data().receptorId));
                        amistades2.docs.forEach(doc => amigosSet.add(doc.data().emisorId));
                        
                        // Obtener salas p√∫blicas
                        const salasSnapshot = await db.collection('salas')
                            .where('visibilidad', '==', VISIBILIDAD.PUBLICA)
                            .get();
                        
                        const salasPublicas = salasSnapshot.docs
                            .map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }))
                            .filter(sala => {
                                // Excluir salas donde ya soy miembro
                                if (sala.miembros && sala.miembros[usuario.uid]) return false;
                                
                                // Si es todo p√∫blico, mostrar
                                if (sala.audiencia === AUDIENCIA.TODO_PUBLICO) return true;
                                
                                // Si es solo amigos, verificar amistad
                                if (sala.audiencia === AUDIENCIA.SOLO_AMIGOS) {
                                    return amigosSet.has(sala.creadorId);
                                }
                                
                                return false;
                            });
                        
                        setSalasPublicasDescubiertas(salasPublicas);
                    } catch (err) {
                        console.error('Error al cargar salas p√∫blicas:', err);
                    }
                }
                
                cargarSalasPublicas();
                
                // Recargar cada 2 minutos
                const interval = setInterval(cargarSalasPublicas, 120000);
                return () => clearInterval(interval);
            }, [usuario.uid]);

            // Verificar ideas expiradas
            useEffect(() => {
                const interval = setInterval(() => {
                    const ahora = Date.now();
                    ideas.forEach(async (idea) => {
                        if (idea.estado === ESTADOS.ACTIVA && idea.expiraAt < ahora) {
                            await db.collection('ideas').doc(idea.id).update({
                                estado: ESTADOS.EXPIRADA
                            });
                        }
                    });
                }, 60000);

                return () => clearInterval(interval);
            }, [ideas]);

            // Limpiar basurero (30 d√≠as)
            useEffect(() => {
                const ahora = Date.now();
                const TREINTA_DIAS = 30 * 24 * 60 * 60 * 1000;
                
                ideas.forEach(async (idea) => {
                    if (idea.estado === ESTADOS.ELIMINADA && idea.eliminadaAt) {
                        if (ahora - idea.eliminadaAt > TREINTA_DIAS) {
                            await db.collection('ideas').doc(idea.id).delete();
                        }
                    }
                });
            }, [ideas]);

            async function crearSala(nombre, color, config = {}) {
                try {
                    const salaData = {
                        nombre: nombre,
                        color: color,
                        creadorId: usuario.uid,
                        creadorNombre: usuario.nombre,
                        miembros: {
                            [usuario.uid]: ROLES.OWNER
                        },
                        visibilidad: config.visibilidad || VISIBILIDAD.PRIVADA,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // Si es p√∫blica, agregar configuraci√≥n adicional
                    if (config.visibilidad === VISIBILIDAD.PUBLICA) {
                        salaData.audiencia = config.audiencia || AUDIENCIA.TODO_PUBLICO;
                        salaData.nivelInteraccion = config.nivelInteraccion || NIVEL_INTERACCION.COMENTARIOS_REACCIONES;
                        salaData.publicadaEn = firebase.firestore.FieldValue.serverTimestamp();
                    }

                    await db.collection('salas').add(salaData);
                    setMostrarModalCrearSala(false);
                } catch (error) {
                    console.error('Error al crear sala:', error);
                    alert('Error al crear la sala: ' + error.message);
                }
            }

            async function eliminarSala(salaId) {
                const sala = salas.find(s => s.id === salaId);
                if (sala && sala.miembros[usuario.uid] !== ROLES.OWNER) {
                    alert('Solo el creador de la sala puede eliminarla');
                    return;
                }
                
                if (confirm('¬øEst√°s seguro de eliminar esta sala y todas sus ideas?')) {
                    try {
                        // Eliminar ideas de la sala
                        const ideasSnapshot = await db.collection('ideas').where('salaId', '==', salaId).get();
                        ideasSnapshot.docs.forEach(async (doc) => {
                            await doc.ref.delete();
                        });

                        // Eliminar sala
                        await db.collection('salas').doc(salaId).delete();

                        if (salaActual === salaId) {
                            setSalaActual(salas[0]?.id || null);
                        }
                    } catch (error) {
                        console.error('Error al eliminar sala:', error);
                        alert('Error al eliminar la sala: ' + error.message);
                    }
                }
            }

            async function crearIdea(texto, duracion) {
                try {
                    const ahora = Date.now();
                    const expira = ahora + (duracion * 60 * 60 * 1000);
                    
                    await db.collection('ideas').add({
                        salaId: salaActual,
                        texto: texto,
                        estado: ESTADOS.INCUBANDO,
                        creadorId: usuario.uid,
                        createdAt: firebase.firestore.Timestamp.fromMillis(ahora),
                        expiraAt: firebase.firestore.Timestamp.fromMillis(expira),
                        reaccionesPorUsuario: {},
                        comentarios: []
                    });
                } catch (error) {
                    console.error('Error al crear idea:', error);
                    alert('Error al crear la idea: ' + error.message);
                }
            }

            async function aprobarIdea(ideaId, textoFinal) {
                const updateData = {
                    estado: ESTADOS.ACTIVA
                };
                
                // Si hay texto final, agregarlo
                if (textoFinal && textoFinal.trim()) {
                    updateData.textoOriginal = ideas.find(i => i.id === ideaId)?.texto;
                    updateData.texto = textoFinal.trim();
                    updateData.editadaAt = firebase.firestore.FieldValue.serverTimestamp();
                }
                
                await db.collection('ideas').doc(ideaId).update(updateData);
            }

            async function rechazarIdea(ideaId) {
                await db.collection('ideas').doc(ideaId).update({
                    estado: ESTADOS.RECHAZADA
                });
            }

            async function marcarRealizada(ideaId) {
                await db.collection('ideas').doc(ideaId).update({
                    estado: ESTADOS.REALIZADA
                });
            }

            async function volverAIncubar(ideaId) {
                await db.collection('ideas').doc(ideaId).update({
                    estado: ESTADOS.INCUBANDO
                });
            }

            async function agregarReaccion(ideaId, emoji) {
                const idea = ideas.find(i => i.id === ideaId);
                if (!idea) return;

                // Nueva estructura: reaccionesPorUsuario = { userId: emoji }
                const reaccionesPorUsuario = { ...(idea.reaccionesPorUsuario || {}) };
                
                // Si el usuario ya reaccion√≥ con el mismo emoji, quitarlo
                if (reaccionesPorUsuario[usuario.uid] === emoji) {
                    delete reaccionesPorUsuario[usuario.uid];
                } else {
                    // Si reaccion√≥ con otro emoji o es nuevo, actualizar
                    reaccionesPorUsuario[usuario.uid] = emoji;
                }

                await db.collection('ideas').doc(ideaId).update({ 
                    reaccionesPorUsuario 
                });
            }

            async function agregarComentario(ideaId, texto, esPropuesta, esAnonimo) {
                const idea = ideas.find(i => i.id === ideaId);
                if (!idea) return;

                const comentario = {
                    id: Date.now().toString(),
                    texto: texto,
                    autorId: esAnonimo ? 'anonimo' : usuario.uid,
                    autorNombre: esAnonimo ? 'An√≥nimo' : usuario.nombre,
                    esPropuesta: esPropuesta,
                    esAnonimo: esAnonimo,
                    estado: esPropuesta ? 'pendiente' : null, // pendiente, aceptada, rechazada
                    timestamp: Date.now()
                };

                await db.collection('ideas').doc(ideaId).update({
                    comentarios: firebase.firestore.FieldValue.arrayUnion(comentario)
                });
            }

            async function responderPropuesta(ideaId, comentarioId, accion) {
                const idea = ideas.find(i => i.id === ideaId);
                if (!idea) return;

                const comentariosActualizados = idea.comentarios.map(c => {
                    if (c.id === comentarioId) {
                        return { ...c, estado: accion }; // 'aceptada' o 'rechazada'
                    }
                    return c;
                });

                await db.collection('ideas').doc(ideaId).update({
                    comentarios: comentariosActualizados
                });
            }

            async function enviarAlBasurero(ideaId) {
                if (confirm('¬øEnviar esta idea al basurero? Se eliminar√° permanentemente en 30 d√≠as.')) {
                    const idea = ideas.find(i => i.id === ideaId);
                    await db.collection('ideas').doc(ideaId).update({
                        estadoAnterior: idea.estado,
                        estado: ESTADOS.ELIMINADA,
                        eliminadaAt: firebase.firestore.Timestamp.fromMillis(Date.now())
                    });
                }
            }

            async function restaurarDeBasurero(ideaId) {
                const idea = ideas.find(i => i.id === ideaId);
                if (idea && idea.estadoAnterior) {
                    await db.collection('ideas').doc(ideaId).update({
                        estado: idea.estadoAnterior,
                        eliminadaAt: null
                    });
                }
            }

            async function eliminarPermanentemente(ideaId) {
                if (confirm('¬øEliminar permanentemente esta idea? Esta acci√≥n no se puede deshacer.')) {
                    await db.collection('ideas').doc(ideaId).delete();
                }
            }

            async function invitarUsuario(salaId, emailInvitado, rol) {
                const sala = salas.find(s => s.id === salaId);
                
                if (!sala || sala.miembros[usuario.uid] !== ROLES.OWNER) {
                    alert('Solo el creador de la sala puede invitar usuarios');
                    return null;
                }

                // Buscar usuario por email
                const usuariosSnapshot = await db.collection('usuarios').where('email', '==', emailInvitado).get();
                
                if (usuariosSnapshot.empty) {
                    alert('No existe un usuario registrado con ese email');
                    return null;
                }

                const usuarioInvitado = usuariosSnapshot.docs[0];
                
                // Verificar que no est√© ya en la sala
                if (sala.miembros[usuarioInvitado.id]) {
                    alert('Este usuario ya es miembro de la sala');
                    return null;
                }

                // Crear invitaci√≥n
                try {
                    const invitacion = {
                        salaId: salaId,
                        salaNombre: sala.nombre,
                        invitadoPor: usuario.nombre,
                        invitadoEmail: emailInvitado,
                        invitadoId: usuarioInvitado.id,
                        rol: rol,
                        estado: 'pendiente',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await db.collection('invitaciones').add(invitacion);
                    return invitacion;
                } catch (error) {
                    console.error('Error al crear invitaci√≥n:', error);
                    alert('Error al enviar invitaci√≥n: ' + error.message);
                    return null;
                }
            }

            async function aceptarInvitacion(invitacionId) {
                const invitacion = invitacionesPendientes.find(i => i.id === invitacionId);
                if (!invitacion) return;

                try {
                    // Agregar usuario a la sala
                    await db.collection('salas').doc(invitacion.salaId).update({
                        [`miembros.${usuario.uid}`]: invitacion.rol
                    });

                    // Actualizar estado de invitaci√≥n
                    await db.collection('invitaciones').doc(invitacionId).update({
                        estado: 'aceptada'
                    });

                    setSalaActual(invitacion.salaId);
                } catch (error) {
                    console.error('Error al aceptar invitaci√≥n:', error);
                    alert('Error al aceptar invitaci√≥n: ' + error.message);
                }
            }

            async function rechazarInvitacion(invitacionId) {
                await db.collection('invitaciones').doc(invitacionId).update({
                    estado: 'rechazada'
                });
            }

            function obtenerRolUsuario(salaId) {
                const sala = salas.find(s => s.id === salaId);
                return sala?.miembros?.[usuario.uid] || null;
            }

            function puedeCrearIdeas(salaId) {
                const rol = obtenerRolUsuario(salaId);
                return rol === ROLES.OWNER || rol === ROLES.EDITOR;
            }

            function puedeComentar(salaId) {
                const rol = obtenerRolUsuario(salaId);
                return rol === ROLES.OWNER || rol === ROLES.EDITOR || rol === ROLES.COMENTADOR;
            }

            function mostrarDesafioAleatorio() {
                const indiceAleatorio = Math.floor(Math.random() * DESAFIOS.length);
                setDesafioActual(DESAFIOS[indiceAleatorio]);
                setMostrarModalDesafio(true);
            }

            // Filtrar ideas
            const ideasDeLaSala = ideas.filter(i => i.estado !== ESTADOS.ELIMINADA);
            
            let ideasFiltradas = ideasDeLaSala;
            if (filtroActivo === 'incubando') {
                ideasFiltradas = ideasDeLaSala.filter(i => i.estado === ESTADOS.INCUBANDO);
            } else if (filtroActivo === 'activas') {
                ideasFiltradas = ideasDeLaSala.filter(i => i.estado === ESTADOS.ACTIVA);
            } else if (filtroActivo === 'realizadas') {
                ideasFiltradas = ideas.filter(i => i.estado === ESTADOS.REALIZADA);
            } else if (filtroActivo === 'rechazadas') {
                ideasFiltradas = ideas.filter(i => i.estado === ESTADOS.RECHAZADA);
            } else if (filtroActivo === 'expiradas') {
                ideasFiltradas = ideas.filter(i => i.estado === ESTADOS.EXPIRADA);
            } else if (filtroActivo === 'basurero') {
                ideasFiltradas = ideas.filter(i => i.estado === ESTADOS.ELIMINADA);
            }

            // Contadores
            const contadores = {
                realizadas: ideas.filter(i => i.estado === ESTADOS.REALIZADA).length,
                rechazadas: ideas.filter(i => i.estado === ESTADOS.RECHAZADA).length,
                expiradas: ideas.filter(i => i.estado === ESTADOS.EXPIRADA).length,
                eliminadas: ideas.filter(i => i.estado === ESTADOS.ELIMINADA).length,
                incubando: ideasDeLaSala.filter(i => i.estado === ESTADOS.INCUBANDO).length,
                activas: ideasDeLaSala.filter(i => i.estado === ESTADOS.ACTIVA).length
            };

            const salaActualData = salas.find(s => s.id === salaActual);

            return (
                <div className="min-h-screen bg-gray-50 flex relative">
                    {/* Overlay para m√≥vil */}
                    {sidebarAbierto && (
                        <div 
                            className="fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden"
                            onClick={() => setSidebarAbierto(false)}
                        ></div>
                    )}

                    {/* Sidebar */}
                    <aside className={`
                        w-64 bg-white shadow-lg min-h-screen overflow-y-auto flex flex-col
                        fixed md:sticky top-0 z-50
                        transition-transform duration-300 ease-out
                        ${sidebarAbierto ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}
                    `}>
                        <div className="p-4 gradient-bg text-white">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    {/* Logo de llama */}
                                    <svg width="32" height="32" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg">
                                        <defs>
                                            <linearGradient id="flameOSidebar" x1="0%" y1="100%" x2="0%" y2="0%">
                                                <stop offset="0%" style={{stopColor:"#fda085"}}/>
                                                <stop offset="50%" style={{stopColor:"#f6d365"}}/>
                                                <stop offset="100%" style={{stopColor:"#fff5cc"}}/>
                                            </linearGradient>
                                            <linearGradient id="flameISidebar" x1="0%" y1="100%" x2="0%" y2="0%">
                                                <stop offset="0%" style={{stopColor:"#f6d365"}}/>
                                                <stop offset="100%" style={{stopColor:"#fff"}}/>
                                            </linearGradient>
                                        </defs>
                                        <g transform="translate(96, 96)">
                                            <path d="M 0,-60 Q -17,-55 -25,-44 Q -31,-32 -31,-17 Q -31,0 -22,13 Q -11,22 0,24 Q 11,22 22,13 Q 31,0 31,-17 Q 31,-32 25,-44 Q 17,-55 0,-60 Z" fill="url(#flameOSidebar)"/>
                                            <path d="M 0,-52 Q -13,-48 -19,-38 Q -23,-27 -23,-13 Q -23,0 -16,11 Q -8,18 0,19 Q 8,18 16,11 Q 23,0 23,-13 Q 23,-27 19,-38 Q 13,-48 0,-52 Z" fill="url(#flameISidebar)" opacity="0.9"/>
                                            <path d="M 0,-38 Q -9,-35 -12,-27 Q -14,-20 -14,-11 Q -14,0 -10,8 Q -4,12 0,13 Q 4,12 10,8 Q 14,0 14,-11 Q 14,-20 12,-27 Q 9,-35 0,-38 Z" fill="#fff" opacity="0.85"/>
                                            <ellipse cx="0" cy="-17" rx="4.5" ry="9" fill="#fff" opacity="0.9"/>
                                        </g>
                                    </svg>
                                    <div>
                                        <h2 className="text-xl font-bold">crea</h2>
                                        <button
                                            onClick={() => {
                                                setMostrarPerfil(true);
                                                setSidebarAbierto(false);
                                            }}
                                            className="text-xs text-purple-100 mt-1 hover:text-white hover:underline transition-colors"
                                        >
                                            üë§ {usuario.nombre}
                                        </button>
                                    </div>
                                </div>
                                {/* Bot√≥n cerrar solo en m√≥vil */}
                                <button 
                                    onClick={() => setSidebarAbierto(false)}
                                    className="md:hidden text-white text-3xl font-bold hover:opacity-80 px-2"
                                    aria-label="Cerrar men√∫"
                                >
                                    √ó
                                </button>
                            </div>
                        </div>

                        {/* Invitaciones Pendientes */}
                        {invitacionesPendientes.length > 0 && (
                            <div className="p-4 border-b bg-yellow-50">
                                <h3 className="text-xs font-bold text-yellow-800 uppercase mb-2">
                                    üì¨ INVITACIONES ({invitacionesPendientes.length})
                                </h3>
                                <div className="space-y-2">
                                    {invitacionesPendientes.map(inv => (
                                        <div key={inv.id} className="bg-white rounded-lg p-2 text-xs">
                                            <p className="font-medium text-gray-800 mb-1">
                                                üìÅ {inv.salaNombre}
                                            </p>
                                            <p className="text-gray-600 text-xs mb-2">
                                                Por: {inv.invitadoPor}
                                            </p>
                                            <div className="flex gap-1">
                                                <button
                                                    onClick={() => {
                                                        aceptarInvitacion(inv.id);
                                                        setSidebarAbierto(false);
                                                    }}
                                                    className="flex-1 bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600"
                                                >
                                                    ‚úì Aceptar
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        rechazarInvitacion(inv.id);
                                                        setSidebarAbierto(false);
                                                    }}
                                                    className="flex-1 bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600"
                                                >
                                                    ‚úó Rechazar
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Archivo */}
                        <div className="p-4 border-b">
                            <h3 className="text-xs font-bold text-gray-500 uppercase mb-2">üìÇ ARCHIVO</h3>
                            <button
                                onClick={() => {
                                    setFiltroActivo('realizadas');
                                    setSidebarAbierto(false);
                                }}
                                className={`w-full text-left px-3 py-2 rounded-lg text-sm mb-1 transition-colors ${
                                    filtroActivo === 'realizadas'
                                        ? 'bg-green-100 text-green-800'
                                        : 'hover:bg-gray-100 text-gray-700'
                                }`}
                            >
                                ‚úì Ideas Realizadas ({contadores.realizadas})
                            </button>
                            <button
                                onClick={() => {
                                    setFiltroActivo('rechazadas');
                                    setSidebarAbierto(false);
                                }}
                                className={`w-full text-left px-3 py-2 rounded-lg text-sm mb-1 transition-colors ${
                                    filtroActivo === 'rechazadas'
                                        ? 'bg-red-100 text-red-800'
                                        : 'hover:bg-gray-100 text-gray-700'
                                }`}
                            >
                                ‚úó Ideas Rechazadas ({contadores.rechazadas})
                            </button>
                            <button
                                onClick={() => {
                                    setFiltroActivo('expiradas');
                                    setSidebarAbierto(false);
                                }}
                                className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${
                                    filtroActivo === 'expiradas'
                                        ? 'bg-gray-200 text-gray-800'
                                        : 'hover:bg-gray-100 text-gray-700'
                                }`}
                            >
                                ‚è∞ Ideas Expiradas ({contadores.expiradas})
                            </button>
                        </div>

                        {/* Salas */}
                        <div className="p-4 flex-1 overflow-y-auto">
                            <div className="flex justify-between items-center mb-2">
                                <h3 className="text-xs font-bold text-gray-500 uppercase">üìö SALAS</h3>
                                <button
                                    onClick={() => setMostrarModalCrearSala(true)}
                                    className="text-purple-600 hover:text-purple-700 font-bold text-xl"
                                    title="Crear nueva sala"
                                >
                                    +
                                </button>
                            </div>

                            {/* Bot√≥n Explorar Salas P√∫blicas */}
                            <button
                                onClick={() => {
                                    setMostrarFeedPublico(true);
                                    setSidebarAbierto(false);
                                }}
                                className="w-full flex items-center gap-2 px-3 py-2 text-purple-600 hover:bg-purple-50 rounded-lg transition-colors font-medium mb-3 text-sm border-2 border-purple-200"
                            >
                                <span>üåê</span>
                                <span>Explorar Salas P√∫blicas</span>
                            </button>

                            {/* Salas Privadas */}
                            {salas.filter(s => !s.visibilidad || s.visibilidad === VISIBILIDAD.PRIVADA).length > 0 && (
                                <div className="mb-4">
                                    <h4 className="text-xs font-semibold text-gray-400 uppercase mb-1 px-1">
                                        üîí Privadas
                                    </h4>
                                    <div className="space-y-1">
                                        {salas
                                            .filter(s => !s.visibilidad || s.visibilidad === VISIBILIDAD.PRIVADA)
                                            .map(sala => {
                                                const colorClasses = {
                                                    blue: 'bg-blue-100 text-blue-800',
                                                    green: 'bg-green-100 text-green-800',
                                                    purple: 'bg-purple-100 text-purple-800',
                                                    red: 'bg-red-100 text-red-800',
                                                    yellow: 'bg-yellow-100 text-yellow-800',
                                                    pink: 'bg-pink-100 text-pink-800',
                                                    indigo: 'bg-indigo-100 text-indigo-800',
                                                    orange: 'bg-orange-100 text-orange-800'
                                                };
                                                
                                                const colorClass = colorClasses[sala.color] || 'bg-gray-100 text-gray-800';
                                                const isActive = salaActual === sala.id;
                                                
                                                return (
                                                    <div key={sala.id} className="flex items-center gap-1">
                                                        <button
                                                            onClick={() => {
                                                                setSalaActual(sala.id);
                                                                setFiltroActivo('todas');
                                                                setSidebarAbierto(false);
                                                            }}
                                                            className={`flex-1 text-left px-3 py-2 rounded-lg text-sm transition-colors ${
                                                                isActive
                                                                    ? colorClass
                                                                    : 'bg-gray-50 hover:bg-gray-100 text-gray-700'
                                                            }`}
                                                        >
                                                            üìÅ {sala.nombre}
                                                        </button>
                                                        {sala.miembros[usuario.uid] === ROLES.OWNER && (
                                                            <button
                                                                onClick={() => eliminarSala(sala.id)}
                                                                className="text-red-500 hover:text-red-700 text-sm px-2"
                                                                title="Eliminar sala"
                                                            >
                                                                ‚úó
                                                            </button>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                    </div>
                                </div>
                            )}

                            {/* Salas P√∫blicas Propias */}
                            {salas.filter(s => s.visibilidad === VISIBILIDAD.PUBLICA).length > 0 && (
                                <div className="mb-4">
                                    <h4 className="text-xs font-semibold text-gray-400 uppercase mb-1 px-1">
                                        üåê P√∫blicas Propias
                                    </h4>
                                    <div className="space-y-1">
                                        {salas
                                            .filter(s => s.visibilidad === VISIBILIDAD.PUBLICA)
                                            .map(sala => {
                                                const colorClasses = {
                                                    blue: 'bg-blue-100 text-blue-800',
                                                    green: 'bg-green-100 text-green-800',
                                                    purple: 'bg-purple-100 text-purple-800',
                                                    red: 'bg-red-100 text-red-800',
                                                    yellow: 'bg-yellow-100 text-yellow-800',
                                                    pink: 'bg-pink-100 text-pink-800',
                                                    indigo: 'bg-indigo-100 text-indigo-800',
                                                    orange: 'bg-orange-100 text-orange-800'
                                                };
                                                
                                                const colorClass = colorClasses[sala.color] || 'bg-gray-100 text-gray-800';
                                                const isActive = salaActual === sala.id;
                                                
                                                return (
                                                    <div key={sala.id} className="flex items-center gap-1">
                                                        <button
                                                            onClick={() => {
                                                                setSalaActual(sala.id);
                                                                setFiltroActivo('todas');
                                                                setSidebarAbierto(false);
                                                            }}
                                                            className={`flex-1 text-left px-3 py-2 rounded-lg text-sm transition-colors flex items-center justify-between ${
                                                                isActive
                                                                    ? colorClass
                                                                    : 'bg-gray-50 hover:bg-gray-100 text-gray-700'
                                                            }`}
                                                        >
                                                            <span>üìÅ {sala.nombre}</span>
                                                            <span className="text-xs opacity-60">üåê</span>
                                                        </button>
                                                        {sala.miembros[usuario.uid] === ROLES.OWNER && (
                                                            <button
                                                                onClick={() => eliminarSala(sala.id)}
                                                                className="text-red-500 hover:text-red-700 text-sm px-2"
                                                                title="Eliminar sala"
                                                            >
                                                                ‚úó
                                                            </button>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                    </div>
                                </div>
                            )}

                            {/* Salas P√∫blicas Descubiertas */}
                            {salasPublicasDescubiertas.length > 0 && (
                                <div>
                                    <h4 className="text-xs font-semibold text-gray-400 uppercase mb-1 px-1">
                                        üîç P√∫blicas Descubiertas
                                    </h4>
                                    <div className="space-y-1">
                                        {salasPublicasDescubiertas.slice(0, 5).map(sala => (
                                            <button
                                                key={sala.id}
                                                onClick={() => {
                                                    setMostrarFeedPublico(true);
                                                    setSidebarAbierto(false);
                                                }}
                                                className="w-full text-left px-3 py-2 rounded-lg text-sm bg-purple-50 hover:bg-purple-100 text-purple-700 transition-colors flex items-center justify-between"
                                            >
                                                <span>üåê {sala.nombre}</span>
                                                <span className="text-xs opacity-60">
                                                    {sala.audiencia === AUDIENCIA.SOLO_AMIGOS ? 'üë•' : 'üåç'}
                                                </span>
                                            </button>
                                        ))}
                                        {salasPublicasDescubiertas.length > 5 && (
                                            <button
                                                onClick={() => {
                                                    setMostrarFeedPublico(true);
                                                    setSidebarAbierto(false);
                                                }}
                                                className="w-full text-center px-3 py-2 text-xs text-purple-600 hover:text-purple-700 font-medium"
                                            >
                                                Ver {salasPublicasDescubiertas.length - 5} m√°s...
                                            </button>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Datos */}
                        <div className="p-4 border-t mt-auto">
                            <h3 className="text-xs font-bold text-gray-500 uppercase mb-2">üíæ DATOS</h3>
                            <button
                                onClick={() => {
                                    setFiltroActivo('basurero');
                                    setSidebarAbierto(false);
                                }}
                                className={`w-full text-left px-3 py-2 rounded-lg text-sm mb-2 transition-colors ${
                                    filtroActivo === 'basurero'
                                        ? 'bg-gray-200 text-gray-800'
                                        : 'hover:bg-gray-100 text-gray-700'
                                }`}
                            >
                                üóëÔ∏è Basurero ({contadores.eliminadas})
                            </button>
                            <button
                                onClick={() => auth.signOut()}
                                className="w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-red-50 text-red-600 font-medium"
                            >
                                üö™ Cerrar Sesi√≥n
                            </button>
                        </div>
                    </aside>

                    {/* Contenido principal */}
                    <main className="flex-1 overflow-y-auto">
                        <header className="bg-white shadow-sm sticky top-0 z-40">
                            <div className="max-w-5xl mx-auto px-4 sm:px-6 py-4">
                                <div className="flex items-center justify-between mb-4">
                                    <div className="flex items-center gap-3">
                                        {/* Bot√≥n hamburguesa solo en m√≥vil */}
                                        <button
                                            onClick={() => setSidebarAbierto(true)}
                                            className="md:hidden text-gray-700 text-2xl"
                                        >
                                            ‚ò∞
                                        </button>
                                        <h1 className="text-xl sm:text-2xl font-bold text-gray-800">
                                            {salaActualData?.nombre || 'Selecciona una sala'}
                                        </h1>
                                    </div>
                                    <div className="flex gap-2">
                                        {salaActual && obtenerRolUsuario(salaActual) === ROLES.OWNER && (
                                            <Tooltip text="Comparte un c√≥digo de invitaci√≥n para que otros se unan a esta sala" posicion="bottom">
                                                <button
                                                    onClick={() => setMostrarModalInvitar(true)}
                                                    className="bg-purple-500 hover:bg-purple-600 text-white px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
                                                >
                                                    <span className="hidden sm:inline">üë• Invitar</span>
                                                    <span className="sm:hidden">üë•</span>
                                                </button>
                                            </Tooltip>
                                        )}
                                        <Tooltip text="Descarga tus ideas en PDF/CSV o genera un reporte de estad√≠sticas" posicion="bottom">
                                            <button
                                                onClick={() => setMostrarModalExportar(true)}
                                                className="bg-blue-500 hover:bg-blue-600 text-white px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
                                            >
                                                <span className="hidden sm:inline">üì• Exportar</span>
                                                <span className="sm:hidden">üì•</span>
                                            </button>
                                        </Tooltip>
                                        <Tooltip text="Obt√©n un prompt creativo aleatorio para inspirarte y crear nuevas ideas" posicion="bottom">
                                            <button
                                                onClick={mostrarDesafioAleatorio}
                                                className="bg-orange-500 hover:bg-orange-600 text-white px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
                                            >
                                                <span className="hidden sm:inline">üé≤ Desaf√≠o</span>
                                                <span className="sm:hidden">üé≤</span>
                                            </button>
                                        </Tooltip>
                                    </div>
                                </div>

                                {/* Pesta√±as */}
                                {salaActual && (
                                    <div className="flex gap-2 overflow-x-auto pb-2 -mx-2 px-2">
                                        <button
                                            onClick={() => setFiltroActivo('todas')}
                                            className={`px-3 sm:px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors text-sm ${
                                                filtroActivo === 'todas'
                                                    ? 'gradient-bg text-white'
                                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                            }`}
                                        >
                                            Todas ({ideasDeLaSala.length})
                                        </button>
                                        <Tooltip text="Ideas en fase inicial (280 chars) que pueden recibir comentarios y propuestas" posicion="bottom">
                                            <button
                                                onClick={() => setFiltroActivo('incubando')}
                                                className={`px-3 sm:px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors text-sm ${
                                                    filtroActivo === 'incubando'
                                                        ? 'bg-yellow-500 text-white'
                                                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                }`}
                                            >
                                                ü•ö Incubando ({contadores.incubando})
                                            </button>
                                        </Tooltip>
                                        <Tooltip text="Ideas aprobadas que est√°n en desarrollo o implementaci√≥n" posicion="bottom">
                                            <button
                                                onClick={() => setFiltroActivo('activas')}
                                                className={`px-3 sm:px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors text-sm ${
                                                    filtroActivo === 'activas'
                                                        ? 'bg-green-500 text-white'
                                                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                }`}
                                            >
                                                ‚ö° Activas ({contadores.activas})
                                            </button>
                                        </Tooltip>
                                    </div>
                                )}
                            </div>
                        </header>

                        <div className="max-w-5xl mx-auto px-4 sm:px-6 py-6">
                            {!salaActual ? (
                                <div className="text-center py-20">
                                    <div className="text-6xl mb-4">üì≠</div>
                                    <h2 className="text-2xl font-bold text-gray-800 mb-2">
                                        Selecciona una sala
                                    </h2>
                                    <p className="text-gray-600">
                                        Crea una nueva sala o acepta una invitaci√≥n
                                    </p>
                                </div>
                            ) : (
                                <div>
                                    {/* Tarjeta crear idea */}
                                    {(filtroActivo === 'todas' || filtroActivo === 'incubando' || filtroActivo === 'activas') && puedeCrearIdeas(salaActual) && (
                                        <CrearIdeaForm onCrear={crearIdea} salaId={salaActual} usuario={usuario} />
                                    )}
                                    
                                    <IdeasList
                                        ideas={ideasFiltradas}
                                        onReaccionar={agregarReaccion}
                                        onComentar={agregarComentario}
                                        onResponderPropuesta={responderPropuesta}
                                        onAprobar={aprobarIdea}
                                        onRechazar={rechazarIdea}
                                        onMarcarRealizada={marcarRealizada}
                                        onVolverAIncubar={volverAIncubar}
                                        onEnviarAlBasurero={enviarAlBasurero}
                                        onRestaurar={restaurarDeBasurero}
                                        onEliminarPermanentemente={eliminarPermanentemente}
                                        esArchivo={filtroActivo === 'realizadas' || filtroActivo === 'rechazadas' || filtroActivo === 'expiradas'}
                                        esBasurero={filtroActivo === 'basurero'}
                                        puedeComentar={salaActual ? puedeComentar(salaActual) : false}
                                        puedeEditar={salaActual ? puedeCrearIdeas(salaActual) : false}
                                        usuarioActual={usuario}
                                    />
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Modales */}
                    {mostrarModalCrearSala && (
                        <ModalCrearSala
                            onCrear={crearSala}
                            onCerrar={() => setMostrarModalCrearSala(false)}
                        />
                    )}

                    {mostrarModalInvitar && (
                        <ModalInvitar
                            salaId={salaActual}
                            salaNombre={salaActualData?.nombre}
                            onInvitar={invitarUsuario}
                            onCerrar={() => setMostrarModalInvitar(false)}
                        />
                    )}

                    {mostrarModalDesafio && desafioActual && (
                        <ModalDesafio
                            desafio={desafioActual}
                            onCerrar={() => setMostrarModalDesafio(false)}
                            onOtro={mostrarDesafioAleatorio}
                        />
                    )}

                    {/* Modal de Exportar */}
                    {mostrarModalExportar && (
                        <ModalExportar
                            salas={salas}
                            salaActual={salaActual}
                            ideas={ideas}
                            usuario={usuario}
                            onCerrar={() => setMostrarModalExportar(false)}
                        />
                    )}

                    {/* Modal de Perfil */}
                    {mostrarPerfil && (
                        <ModalPerfil
                            usuario={usuario}
                            onCerrar={() => setMostrarPerfil(false)}
                        />
                    )}

                    {/* Modal Feed P√∫blico */}
                    {mostrarFeedPublico && (
                        <ModalFeedPublico
                            usuario={usuario}
                            onCerrar={() => setMostrarFeedPublico(false)}
                        />
                    )}
                </div>
            );
        }

        // Componente CrearIdeaForm
        function CrearIdeaForm({ onCrear, salaId, usuario }) {
            const [texto, setTexto] = useState('');
            const [duracion, setDuracion] = useState(24);
            const [borradorGuardado, setBorradorGuardado] = useState(false);

            // Cargar borrador al montar
            useEffect(() => {
                const borradorKey = `borrador_${usuario.uid}_${salaId}`;
                const borradorGuardado = localStorage.getItem(borradorKey);
                
                if (borradorGuardado) {
                    try {
                        const borrador = JSON.parse(borradorGuardado);
                        setTexto(borrador.texto || '');
                        setDuracion(borrador.duracion || 24);
                    } catch (e) {
                        console.error('Error al cargar borrador:', e);
                    }
                }
            }, [usuario.uid, salaId]);

            // Guardar borrador autom√°ticamente
            useEffect(() => {
                if (texto.trim().length > 0) {
                    const timer = setTimeout(() => {
                        guardarBorrador();
                    }, 1000); // Guarda despu√©s de 1 segundo de inactividad
                    
                    return () => clearTimeout(timer);
                }
            }, [texto, duracion]);

            function guardarBorrador() {
                const borradorKey = `borrador_${usuario.uid}_${salaId}`;
                const borrador = { texto, duracion, timestamp: Date.now() };
                localStorage.setItem(borradorKey, JSON.stringify(borrador));
                
                setBorradorGuardado(true);
                setTimeout(() => setBorradorGuardado(false), 2000);
            }

            function limpiarBorrador() {
                const borradorKey = `borrador_${usuario.uid}_${salaId}`;
                localStorage.removeItem(borradorKey);
            }

            function handleSubmit(e) {
                e.preventDefault();
                if (texto.trim()) {
                    onCrear(texto.trim(), duracion);
                    setTexto('');
                    limpiarBorrador();
                }
            }

            function handleDescartarBorrador() {
                if (confirm('¬øDescartar el borrador actual?')) {
                    setTexto('');
                    limpiarBorrador();
                }
            }

            return (
                <div className="bg-white rounded-xl shadow-md p-4 sm:p-6 mb-6 fade-in">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-lg sm:text-xl font-bold text-gray-800">üí° Comparte tu idea</h2>
                        {texto.trim().length > 0 && (
                            <div className="flex items-center gap-2">
                                {borradorGuardado && (
                                    <span className="text-xs text-green-600 flex items-center gap-1">
                                        <span>‚úì</span>
                                        <span className="hidden sm:inline">Borrador guardado</span>
                                    </span>
                                )}
                                <button
                                    type="button"
                                    onClick={handleDescartarBorrador}
                                    className="text-xs text-red-600 hover:text-red-700 px-2 py-1 rounded hover:bg-red-50"
                                >
                                    üóëÔ∏è Descartar
                                </button>
                            </div>
                        )}
                    </div>
                    <form onSubmit={handleSubmit}>
                        <textarea
                            value={texto}
                            onChange={(e) => setTexto(e.target.value.slice(0, CHAR_LIMIT))}
                            placeholder="Escribe tu premisa o idea de forma concisa... (se guarda autom√°ticamente como borrador)"
                            className="w-full p-4 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none resize-none text-base"
                            rows="4"
                            style={{ fontSize: '16px' }}
                        />
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mt-3">
                            <div className="flex items-center gap-4 w-full sm:w-auto">
                                <select
                                    value={duracion}
                                    onChange={(e) => setDuracion(Number(e.target.value))}
                                    className="px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none text-sm flex-1 sm:flex-initial"
                                    style={{ fontSize: '16px' }}
                                >
                                    <option value={24}>24 horas</option>
                                    <option value={48}>48 horas</option>
                                    <option value={72}>72 horas</option>
                                </select>
                                <span className="text-sm text-gray-500 whitespace-nowrap">
                                    {texto.length}/{CHAR_LIMIT}
                                </span>
                            </div>
                            <button
                                type="submit"
                                disabled={texto.trim().length === 0}
                                className="w-full sm:w-auto gradient-bg text-white px-6 py-3 rounded-lg font-medium hover:opacity-90 transition-opacity disabled:opacity-50"
                            >
                                Publicar Idea
                            </button>
                        </div>
                    </form>
                    {texto.trim().length > 0 && (
                        <div className="mt-3 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                            <p className="text-xs text-blue-800">
                                üíæ <strong>Borrador autom√°tico:</strong> Tu idea se guarda autom√°ticamente mientras escribes. 
                                Puedes cerrar y volver m√°s tarde sin perder tu trabajo.
                            </p>
                        </div>
                    )}
                </div>
            );
        }

        // Componente IdeasList
        function IdeasList({ ideas, onReaccionar, onComentar, onResponderPropuesta, onAprobar, onRechazar, onMarcarRealizada, onVolverAIncubar, onEnviarAlBasurero, onRestaurar, onEliminarPermanentemente, esArchivo, esBasurero, puedeComentar, puedeEditar, usuarioActual }) {
            if (ideas.length === 0) {
                return (
                    <div className="text-center py-20">
                        <div className="text-6xl mb-4">{esBasurero ? 'üóëÔ∏è' : 'üí°'}</div>
                        <h3 className="text-xl font-bold text-gray-800 mb-2">
                            {esBasurero 
                                ? 'El basurero est√° vac√≠o' 
                                : esArchivo 
                                    ? 'No hay ideas en este archivo' 
                                    : 'A√∫n no hay ideas'}
                        </h3>
                        <p className="text-gray-600">
                            {esBasurero 
                                ? 'Las ideas eliminadas aparecer√°n aqu√≠ por 30 d√≠as'
                                : '¬°S√© el primero en compartir una idea creativa!'}
                        </p>
                    </div>
                );
            }

            return (
                <div className="space-y-4">
                    {ideas.map(idea => (
                        <TarjetaIdea
                            key={idea.id}
                            idea={idea}
                            onReaccionar={onReaccionar}
                            onComentar={onComentar}
                            onResponderPropuesta={onResponderPropuesta}
                            onAprobar={onAprobar}
                            onRechazar={onRechazar}
                            onMarcarRealizada={onMarcarRealizada}
                            onVolverAIncubar={onVolverAIncubar}
                            onEnviarAlBasurero={onEnviarAlBasurero}
                            onRestaurar={onRestaurar}
                            onEliminarPermanentemente={onEliminarPermanentemente}
                            esArchivo={esArchivo}
                            esBasurero={esBasurero}
                            puedeComentar={puedeComentar}
                            puedeEditar={puedeEditar}
                            usuarioActual={usuarioActual}
                        />
                    ))}
                </div>
            );
        }

        // Componente TarjetaIdea
        function TarjetaIdea({ idea, onReaccionar, onComentar, onResponderPropuesta, onAprobar, onRechazar, onMarcarRealizada, onVolverAIncubar, onEnviarAlBasurero, onRestaurar, onEliminarPermanentemente, esArchivo, esBasurero, puedeComentar, puedeEditar, usuarioActual }) {
            const [expandida, setExpandida] = useState(false);
            const [mostrarReacciones, setMostrarReacciones] = useState(false);
            const [nuevoComentario, setNuevoComentario] = useState('');
            const [esPropuesta, setEsPropuesta] = useState(false);
            const [esAnonimo, setEsAnonimo] = useState(false);
            const [mostrarModalAprobar, setMostrarModalAprobar] = useState(false);

            const ahora = Date.now();
            const tiempoRestante = Math.max(0, idea.expiraAt - ahora);
            const horasRestantes = Math.floor(tiempoRestante / (1000 * 60 * 60));
            const minutosRestantes = Math.floor((tiempoRestante % (1000 * 60 * 60)) / (1000 * 60));

            const diasEnBasurero = idea.eliminadaAt 
                ? Math.ceil((30 * 24 * 60 * 60 * 1000 - (ahora - idea.eliminadaAt)) / (24 * 60 * 60 * 1000))
                : 0;

            const estadoConfig = {
                [ESTADOS.INCUBANDO]: { bg: 'bg-yellow-50', border: 'border-yellow-300', text: 'text-yellow-800', icono: 'ü•ö' },
                [ESTADOS.ACTIVA]: { bg: 'bg-green-50', border: 'border-green-300', text: 'text-green-800', icono: '‚ö°' },
                [ESTADOS.REALIZADA]: { bg: 'bg-green-50', border: 'border-green-300', text: 'text-green-800', icono: '‚úì' },
                [ESTADOS.RECHAZADA]: { bg: 'bg-red-50', border: 'border-red-300', text: 'text-red-800', icono: '‚úó' },
                [ESTADOS.EXPIRADA]: { bg: 'bg-gray-50', border: 'border-gray-300', text: 'text-gray-800', icono: '‚è∞' },
                [ESTADOS.ELIMINADA]: { bg: 'bg-gray-100', border: 'border-gray-400', text: 'text-gray-700', icono: 'üóëÔ∏è' }
            };

            const config = estadoConfig[idea.estado];

            function handleEnviarComentario() {
                if (nuevoComentario.trim()) {
                    onComentar(idea.id, nuevoComentario.trim(), esPropuesta, esAnonimo);
                    setNuevoComentario('');
                    setEsPropuesta(false);
                    setEsAnonimo(false);
                }
            }

            return (
                <div className={`bg-white rounded-xl shadow-md p-6 fade-in border-l-4 ${config.border}`}>
                    <div className="flex justify-between items-start mb-4">
                        <div className="flex items-center gap-2">
                            <span className={`px-3 py-1 rounded text-xs font-medium ${config.bg} ${config.text}`}>
                                {config.icono} {idea.estado.charAt(0).toUpperCase() + idea.estado.slice(1)}
                            </span>
                            {idea.estado === ESTADOS.ACTIVA && (
                                <span className="text-xs text-gray-500">
                                    ‚è±Ô∏è {horasRestantes}h {minutosRestantes}m
                                </span>
                            )}
                            {esBasurero && (
                                <span className="text-xs text-red-500">
                                    ‚ö†Ô∏è Se eliminar√° en {diasEnBasurero} d√≠as
                                </span>
                            )}
                        </div>
                        {idea.estado === ESTADOS.ACTIVA && !esArchivo && !esBasurero && puedeEditar && (
                            <div className="flex gap-2 flex-wrap">
                                <button
                                    onClick={() => onVolverAIncubar(idea.id)}
                                    className="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-medium"
                                >
                                    ü•ö Volver a Incubar
                                </button>
                                <button
                                    onClick={() => onMarcarRealizada(idea.id)}
                                    className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium"
                                >
                                    ‚úì Realizada
                                </button>
                            </div>
                        )}
                    </div>

                    <p className="text-gray-800 text-lg mb-2">{idea.texto}</p>
                    
                    {/* Mostrar si fue editada */}
                    {idea.textoOriginal && (
                        <div className="mb-4">
                            <span className="inline-flex items-center gap-1 text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded mb-2">
                                ‚úèÔ∏è Idea editada al aprobar
                            </span>
                            <details className="text-sm">
                                <summary className="cursor-pointer text-gray-600 hover:text-gray-800">
                                    Ver texto original
                                </summary>
                                <div className="mt-2 p-3 bg-gray-50 rounded border-l-2 border-gray-300">
                                    <p className="text-gray-600 italic">{idea.textoOriginal}</p>
                                </div>
                            </details>
                        </div>
                    )}

                    {esBasurero && puedeEditar && (
                        <div className="flex gap-2 mb-4">
                            <button
                                onClick={() => onRestaurar(idea.id)}
                                className="flex-1 bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 font-medium"
                            >
                                ‚Ü©Ô∏è Restaurar
                            </button>
                            <button
                                onClick={() => onEliminarPermanentemente(idea.id)}
                                className="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 font-medium"
                            >
                                üóëÔ∏è Eliminar permanentemente
                            </button>
                        </div>
                    )}

                    {esArchivo && !esBasurero && puedeEditar && (
                        <button
                            onClick={() => onEnviarAlBasurero(idea.id)}
                            className="mb-4 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium text-sm"
                        >
                            üóëÔ∏è Enviar al basurero
                        </button>
                    )}

                    {idea.estado === ESTADOS.INCUBANDO && !esArchivo && !esBasurero && puedeEditar && (
                        <div className="flex gap-2 mb-4">
                            <button
                                onClick={() => setMostrarModalAprobar(true)}
                                className="flex-1 bg-green-100 text-green-700 px-4 py-2 rounded-lg hover:bg-green-200 font-medium"
                            >
                                ‚úì Aprobar Idea
                            </button>
                            <button
                                onClick={() => onRechazar(idea.id)}
                                className="flex-1 bg-red-100 text-red-700 px-4 py-2 rounded-lg hover:bg-red-200 font-medium"
                            >
                                ‚úó Rechazar Idea
                            </button>
                        </div>
                    )}

                    {!esArchivo && !esBasurero && (
                        <div className="flex flex-wrap gap-2 mb-4">
                            {(() => {
                                // Agrupar reacciones por emoji y contar
                                const reaccionesPorUsuario = idea.reaccionesPorUsuario || {};
                                const contadorEmojis = {};
                                const reaccionUsuarioActual = reaccionesPorUsuario[usuarioActual?.uid];
                                
                                Object.values(reaccionesPorUsuario).forEach(emoji => {
                                    contadorEmojis[emoji] = (contadorEmojis[emoji] || 0) + 1;
                                });
                                
                                return Object.entries(contadorEmojis).map(([emoji, count]) => (
                                    <button
                                        key={emoji}
                                        onClick={() => onReaccionar(idea.id, emoji)}
                                        className={`px-3 py-1 rounded-full text-sm transition-colors ${
                                            reaccionUsuarioActual === emoji
                                                ? 'bg-purple-100 hover:bg-purple-200 ring-2 ring-purple-400'
                                                : 'bg-gray-100 hover:bg-gray-200'
                                        }`}
                                    >
                                        {emoji} {count}
                                    </button>
                                ));
                            })()}
                            {idea.estado !== ESTADOS.RECHAZADA && idea.estado !== ESTADOS.EXPIRADA && (
                                <div className="relative">
                                    <button
                                        onClick={() => setMostrarReacciones(!mostrarReacciones)}
                                        className="px-3 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-full text-sm"
                                    >
                                        + Reaccionar
                                    </button>
                                    {mostrarReacciones && (
                                        <div className="absolute top-full mt-2 bg-white shadow-lg rounded-lg p-2 flex gap-1 z-10 border-2 border-purple-200">
                                            {reaccionesDisponibles.map(emoji => {
                                                const reaccionUsuarioActual = (idea.reaccionesPorUsuario || {})[usuarioActual?.uid];
                                                const esSeleccionado = reaccionUsuarioActual === emoji;
                                                
                                                return (
                                                    <button
                                                        key={emoji}
                                                        onClick={() => {
                                                            onReaccionar(idea.id, emoji);
                                                            setMostrarReacciones(false);
                                                        }}
                                                        className={`text-2xl hover:scale-125 transition-transform p-1 rounded ${
                                                            esSeleccionado ? 'bg-purple-100 ring-2 ring-purple-400' : ''
                                                        }`}
                                                        title={esSeleccionado ? 'Click para quitar tu reacci√≥n' : ''}
                                                    >
                                                        {emoji}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    <button
                        onClick={() => setExpandida(!expandida)}
                        className="text-purple-600 hover:text-purple-700 font-medium text-sm mb-2"
                    >
                        {expandida ? '‚ñº Ocultar comentarios' : `‚ñ∂ Ver comentarios (${(idea.comentarios || []).length})`}
                    </button>

                    {expandida && (
                        <div className="mt-4 space-y-3 border-t pt-4">
                            {(idea.comentarios || []).map(comentario => (
                                <div key={comentario.id} className={`rounded-lg p-3 ${
                                    comentario.esPropuesta && comentario.estado === 'aceptada' ? 'bg-green-50 border-2 border-green-200' :
                                    comentario.esPropuesta && comentario.estado === 'rechazada' ? 'bg-red-50 border-2 border-red-200' :
                                    'bg-gray-50'
                                }`}>
                                    <div className="flex justify-between items-start mb-1 flex-wrap gap-2">
                                        <div className="flex items-center gap-2">
                                            <span className="font-medium text-sm">{comentario.autorNombre}</span>
                                            {comentario.esAnonimo && (
                                                <span className="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded">
                                                    üë§ An√≥nimo
                                                </span>
                                            )}
                                        </div>
                                        <div className="flex gap-2">
                                            {comentario.esPropuesta && (
                                                <>
                                                    {comentario.estado === 'pendiente' && (
                                                        <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                                            üí° Propuesta
                                                        </span>
                                                    )}
                                                    {comentario.estado === 'aceptada' && (
                                                        <span className="text-xs bg-green-600 text-white px-2 py-1 rounded font-medium">
                                                            ‚úì Aceptada
                                                        </span>
                                                    )}
                                                    {comentario.estado === 'rechazada' && (
                                                        <span className="text-xs bg-red-600 text-white px-2 py-1 rounded font-medium">
                                                            ‚úó Rechazada
                                                        </span>
                                                    )}
                                                </>
                                            )}
                                        </div>
                                    </div>
                                    <p className="text-gray-700 mb-2">{comentario.texto}</p>
                                    
                                    {/* Botones para aceptar/rechazar propuestas */}
                                    {comentario.esPropuesta && comentario.estado === 'pendiente' && puedeEditar && !esArchivo && !esBasurero && (
                                        <div className="flex gap-2 mt-3">
                                            <button
                                                onClick={() => onResponderPropuesta(idea.id, comentario.id, 'aceptada')}
                                                className="flex-1 bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded text-sm font-medium transition-colors"
                                            >
                                                ‚úì Aceptar propuesta
                                            </button>
                                            <button
                                                onClick={() => onResponderPropuesta(idea.id, comentario.id, 'rechazada')}
                                                className="flex-1 bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded text-sm font-medium transition-colors"
                                            >
                                                ‚úó Rechazar
                                            </button>
                                        </div>
                                    )}
                                </div>
                            ))}

                            {!esArchivo && !esBasurero && idea.estado !== ESTADOS.RECHAZADA && idea.estado !== ESTADOS.EXPIRADA && puedeComentar && (
                                <div className="bg-purple-50 rounded-lg p-3">
                                    <textarea
                                        value={nuevoComentario}
                                        onChange={(e) => setNuevoComentario(e.target.value.slice(0, COMMENT_LIMIT))}
                                        placeholder="Agrega tu comentario o propuesta..."
                                        className="w-full p-2 border border-purple-200 rounded-lg focus:border-purple-500 focus:outline-none resize-none text-sm"
                                        rows="2"
                                    />
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mt-2">
                                        <div className="flex flex-col gap-2">
                                            <label className="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={esPropuesta}
                                                    onChange={(e) => setEsPropuesta(e.target.checked)}
                                                    className="rounded"
                                                />
                                                üí° Marcar como propuesta
                                            </label>
                                            <label className="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={esAnonimo}
                                                    onChange={(e) => setEsAnonimo(e.target.checked)}
                                                    className="rounded"
                                                />
                                                üë§ Publicar an√≥nimamente
                                            </label>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-xs text-gray-500">
                                                {nuevoComentario.length}/{COMMENT_LIMIT}
                                            </span>
                                            <button
                                                onClick={handleEnviarComentario}
                                                disabled={nuevoComentario.trim().length === 0}
                                                className="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700 disabled:bg-gray-300"
                                            >
                                                Enviar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Modal de Aprobar Idea */}
                    {mostrarModalAprobar && (
                        <ModalAprobarIdea
                            idea={idea}
                            onAprobar={onAprobar}
                            onCerrar={() => setMostrarModalAprobar(false)}
                        />
                    )}
                </div>
            );
        }

        // Modal Crear Sala
        function ModalCrearSala({ onCrear, onCerrar }) {
            const [nombre, setNombre] = useState('');
            const [colorSeleccionado, setColorSeleccionado] = useState('blue');
            const [visibilidad, setVisibilidad] = useState(VISIBILIDAD.PRIVADA);
            const [audiencia, setAudiencia] = useState(AUDIENCIA.TODO_PUBLICO);
            const [nivelInteraccion, setNivelInteraccion] = useState(NIVEL_INTERACCION.COMENTARIOS_REACCIONES);
            const [mostrarConfigAvanzada, setMostrarConfigAvanzada] = useState(false);

            const colores = [
                { id: 'blue', bg: 'bg-blue-500', label: 'Azul' },
                { id: 'green', bg: 'bg-green-500', label: 'Verde' },
                { id: 'purple', bg: 'bg-purple-500', label: 'Morado' },
                { id: 'red', bg: 'bg-red-500', label: 'Rojo' },
                { id: 'yellow', bg: 'bg-yellow-500', label: 'Amarillo' },
                { id: 'pink', bg: 'bg-pink-500', label: 'Rosa' },
                { id: 'indigo', bg: 'bg-indigo-500', label: '√çndigo' },
                { id: 'orange', bg: 'bg-orange-500', label: 'Naranja' }
            ];

            function handleSubmit(e) {
                e.preventDefault();
                if (nombre.trim()) {
                    onCrear(nombre.trim(), colorSeleccionado, {
                        visibilidad,
                        audiencia: visibilidad === VISIBILIDAD.PUBLICA ? audiencia : null,
                        nivelInteraccion: visibilidad === VISIBILIDAD.PUBLICA ? nivelInteraccion : null
                    });
                }
            }

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl fade-in max-h-[90vh] overflow-y-auto">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">Nueva Sala</h2>
                        
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Nombre de la sala
                                </label>
                                <input
                                    type="text"
                                    value={nombre}
                                    onChange={(e) => setNombre(e.target.value)}
                                    placeholder="Ej: Marketing, Desarrollo..."
                                    autoFocus
                                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-3">
                                    Color
                                </label>
                                <div className="flex gap-3 flex-wrap">
                                    {colores.map(color => (
                                        <button
                                            key={color.id}
                                            type="button"
                                            onClick={() => setColorSeleccionado(color.id)}
                                            className={`w-12 h-12 rounded-full ${color.bg} transition-transform ${
                                                colorSeleccionado === color.id
                                                    ? 'ring-4 ring-offset-2 ring-gray-400 scale-110'
                                                    : 'hover:scale-105'
                                            }`}
                                            title={color.label}
                                        />
                                    ))}
                                </div>
                            </div>

                            {/* Visibilidad */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-3">
                                    Visibilidad
                                </label>
                                <div className="grid grid-cols-2 gap-3">
                                    <button
                                        type="button"
                                        onClick={() => setVisibilidad(VISIBILIDAD.PRIVADA)}
                                        className={`p-4 rounded-lg border-2 transition-all ${
                                            visibilidad === VISIBILIDAD.PRIVADA
                                                ? 'border-purple-500 bg-purple-50'
                                                : 'border-gray-200 hover:border-gray-300'
                                        }`}
                                    >
                                        <div className="text-2xl mb-1">üîí</div>
                                        <div className="font-semibold text-gray-800">Privada</div>
                                        <div className="text-xs text-gray-600 mt-1">Solo miembros invitados</div>
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => {
                                            setVisibilidad(VISIBILIDAD.PUBLICA);
                                            setMostrarConfigAvanzada(true);
                                        }}
                                        className={`p-4 rounded-lg border-2 transition-all ${
                                            visibilidad === VISIBILIDAD.PUBLICA
                                                ? 'border-blue-500 bg-blue-50'
                                                : 'border-gray-200 hover:border-gray-300'
                                        }`}
                                    >
                                        <div className="text-2xl mb-1">üåç</div>
                                        <div className="font-semibold text-gray-800">P√∫blica</div>
                                        <div className="text-xs text-gray-600 mt-1">Visible para tu audiencia</div>
                                    </button>
                                </div>
                            </div>

                            {/* Configuraci√≥n avanzada para salas p√∫blicas */}
                            {visibilidad === VISIBILIDAD.PUBLICA && (
                                <div className="space-y-4 border-t-2 pt-4">
                                    <div className="flex items-center justify-between">
                                        <h3 className="text-sm font-bold text-gray-800">‚öôÔ∏è Configuraci√≥n de Sala P√∫blica</h3>
                                    </div>

                                    {/* Audiencia */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            ¬øQui√©n puede ver esta sala?
                                        </label>
                                        <div className="space-y-2">
                                            <button
                                                type="button"
                                                onClick={() => setAudiencia(AUDIENCIA.TODO_PUBLICO)}
                                                className={`w-full text-left p-3 rounded-lg border-2 transition-all ${
                                                    audiencia === AUDIENCIA.TODO_PUBLICO
                                                        ? 'border-green-500 bg-green-50'
                                                        : 'border-gray-200 hover:border-gray-300'
                                                }`}
                                            >
                                                <div className="flex items-center gap-3">
                                                    <span className="text-xl">üåê</span>
                                                    <div className="flex-1">
                                                        <div className="font-medium text-gray-800">Todo P√∫blico</div>
                                                        <div className="text-xs text-gray-600">Cualquier usuario registrado puede ver</div>
                                                    </div>
                                                    {audiencia === AUDIENCIA.TODO_PUBLICO && <span className="text-green-600">‚úì</span>}
                                                </div>
                                            </button>
                                            
                                            <button
                                                type="button"
                                                onClick={() => setAudiencia(AUDIENCIA.SOLO_AMIGOS)}
                                                className={`w-full text-left p-3 rounded-lg border-2 transition-all ${
                                                    audiencia === AUDIENCIA.SOLO_AMIGOS
                                                        ? 'border-purple-500 bg-purple-50'
                                                        : 'border-gray-200 hover:border-gray-300'
                                                }`}
                                            >
                                                <div className="flex items-center gap-3">
                                                    <span className="text-xl">ü§ù</span>
                                                    <div className="flex-1">
                                                        <div className="font-medium text-gray-800">Solo Amigos</div>
                                                        <div className="text-xs text-gray-600">Solo tus contactos aceptados pueden ver</div>
                                                    </div>
                                                    {audiencia === AUDIENCIA.SOLO_AMIGOS && <span className="text-purple-600">‚úì</span>}
                                                </div>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Nivel de Interacci√≥n */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            ¬øQu√© pueden hacer los visitantes?
                                        </label>
                                        <div className="space-y-2">
                                            <button
                                                type="button"
                                                onClick={() => setNivelInteraccion(NIVEL_INTERACCION.SOLO_LECTURA)}
                                                className={`w-full text-left p-3 rounded-lg border-2 transition-all ${
                                                    nivelInteraccion === NIVEL_INTERACCION.SOLO_LECTURA
                                                        ? 'border-gray-500 bg-gray-50'
                                                        : 'border-gray-200 hover:border-gray-300'
                                                }`}
                                            >
                                                <div className="flex items-center gap-3">
                                                    <span className="text-xl">üëÅÔ∏è</span>
                                                    <div className="flex-1">
                                                        <div className="font-medium text-gray-800">Solo Lectura</div>
                                                        <div className="text-xs text-gray-600">Ver ideas sin interactuar</div>
                                                    </div>
                                                    {nivelInteraccion === NIVEL_INTERACCION.SOLO_LECTURA && <span className="text-gray-600">‚úì</span>}
                                                </div>
                                            </button>
                                            
                                            <button
                                                type="button"
                                                onClick={() => setNivelInteraccion(NIVEL_INTERACCION.COMENTARIOS_REACCIONES)}
                                                className={`w-full text-left p-3 rounded-lg border-2 transition-all ${
                                                    nivelInteraccion === NIVEL_INTERACCION.COMENTARIOS_REACCIONES
                                                        ? 'border-orange-500 bg-orange-50'
                                                        : 'border-gray-200 hover:border-gray-300'
                                                }`}
                                            >
                                                <div className="flex items-center gap-3">
                                                    <span className="text-xl">üí¨</span>
                                                    <div className="flex-1">
                                                        <div className="font-medium text-gray-800">Comentarios y Reacciones</div>
                                                        <div className="text-xs text-gray-600">Pueden comentar y reaccionar</div>
                                                    </div>
                                                    {nivelInteraccion === NIVEL_INTERACCION.COMENTARIOS_REACCIONES && <span className="text-orange-600">‚úì</span>}
                                                </div>
                                            </button>
                                            
                                            <button
                                                type="button"
                                                onClick={() => setNivelInteraccion(NIVEL_INTERACCION.FULL_INTERACCION)}
                                                className={`w-full text-left p-3 rounded-lg border-2 transition-all ${
                                                    nivelInteraccion === NIVEL_INTERACCION.FULL_INTERACCION
                                                        ? 'border-green-500 bg-green-50'
                                                        : 'border-gray-200 hover:border-gray-300'
                                                }`}
                                            >
                                                <div className="flex items-center gap-3">
                                                    <span className="text-xl">‚ö°</span>
                                                    <div className="flex-1">
                                                        <div className="font-medium text-gray-800">Interacci√≥n Completa</div>
                                                        <div className="text-xs text-gray-600">Comentar, reaccionar y proponer</div>
                                                    </div>
                                                    {nivelInteraccion === NIVEL_INTERACCION.FULL_INTERACCION && <span className="text-green-600">‚úì</span>}
                                                </div>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            <div className="flex gap-3 pt-4 border-t">
                                <button
                                    type="button"
                                    onClick={onCerrar}
                                    className="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors"
                                >
                                    Cancelar
                                </button>
                                <button
                                    type="submit"
                                    disabled={!nombre.trim()}
                                    className="flex-1 px-6 py-3 gradient-bg text-white rounded-lg hover:opacity-90 font-medium transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Crear Sala
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Modal Invitar
        // Componente Tooltip
        function Tooltip({ children, text, posicion = 'top' }) {
            const [mostrar, setMostrar] = useState(false);

            const posiciones = {
                top: 'bottom-full left-1/2 -translate-x-1/2 mb-2',
                bottom: 'top-full left-1/2 -translate-x-1/2 mt-2',
                left: 'right-full top-1/2 -translate-y-1/2 mr-2',
                right: 'left-full top-1/2 -translate-y-1/2 ml-2'
            };

            return (
                <div 
                    className="relative inline-block"
                    onMouseEnter={() => setMostrar(true)}
                    onMouseLeave={() => setMostrar(false)}
                    onClick={() => setMostrar(!mostrar)}
                >
                    {children}
                    {mostrar && (
                        <div className={`absolute ${posiciones[posicion]} z-50 w-64 px-3 py-2 text-sm text-white bg-gray-900 rounded-lg shadow-lg`}>
                            {text}
                            <div className={`absolute w-2 h-2 bg-gray-900 transform rotate-45 ${
                                posicion === 'top' ? 'bottom-[-4px] left-1/2 -translate-x-1/2' :
                                posicion === 'bottom' ? 'top-[-4px] left-1/2 -translate-x-1/2' :
                                posicion === 'left' ? 'right-[-4px] top-1/2 -translate-y-1/2' :
                                'left-[-4px] top-1/2 -translate-y-1/2'
                            }`}></div>
                        </div>
                    )}
                </div>
            );
        }

        function ModalInvitar({ salaId, salaNombre, onInvitar, onCerrar }) {
            const [codigoSala, setCodigoSala] = useState('');
            const [cargando, setCargando] = useState(true);
            const [copiado, setCopiado] = useState(false);

            useEffect(() => {
                generarObtenerCodigo();
            }, []);

            async function generarObtenerCodigo() {
                try {
                    // Verificar si la sala ya tiene un c√≥digo
                    const salaDoc = await db.collection('salas').doc(salaId).get();
                    
                    if (salaDoc.exists && salaDoc.data().codigoInvitacion) {
                        setCodigoSala(salaDoc.data().codigoInvitacion);
                    } else {
                        // Generar nuevo c√≥digo √∫nico
                        const codigo = generarCodigoUnico();
                        
                        // Guardar en Firestore
                        await db.collection('salas').doc(salaId).update({
                            codigoInvitacion: codigo
                        });
                        
                        setCodigoSala(codigo);
                    }
                } catch (error) {
                    console.error('Error al generar c√≥digo:', error);
                    // Generar c√≥digo temporal si hay error
                    setCodigoSala(generarCodigoUnico());
                } finally {
                    setCargando(false);
                }
            }

            function generarCodigoUnico() {
                // Generar c√≥digo de 8 caracteres: SALA-XXXX
                const caracteres = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Sin caracteres confusos
                let codigo = 'SALA-';
                for (let i = 0; i < 4; i++) {
                    codigo += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
                }
                return codigo;
            }

            async function copiarCodigo() {
                try {
                    await navigator.clipboard.writeText(codigoSala);
                    setCopiado(true);
                    setTimeout(() => setCopiado(false), 2000);
                } catch (err) {
                    // Fallback para navegadores sin clipboard API
                    const textArea = document.createElement('textarea');
                    textArea.value = codigoSala;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    setCopiado(true);
                    setTimeout(() => setCopiado(false), 2000);
                }
            }

            async function regenerarCodigo() {
                setCargando(true);
                const nuevoCodigo = generarCodigoUnico();
                
                try {
                    await db.collection('salas').doc(salaId).update({
                        codigoInvitacion: nuevoCodigo
                    });
                    setCodigoSala(nuevoCodigo);
                } catch (error) {
                    console.error('Error al regenerar c√≥digo:', error);
                    alert('Error al regenerar el c√≥digo. Intenta de nuevo.');
                } finally {
                    setCargando(false);
                }
            }

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-lg fade-in">
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-1">
                                    Invitar a "{salaNombre}"
                                </h2>
                                <p className="text-sm text-gray-600">
                                    Comparte este c√≥digo con tu equipo
                                </p>
                            </div>
                            <button
                                onClick={onCerrar}
                                className="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                            >
                                √ó
                            </button>
                        </div>

                        {cargando ? (
                            <div className="text-center py-12">
                                <div className="text-4xl mb-3">‚è≥</div>
                                <p className="text-gray-600">Generando c√≥digo...</p>
                            </div>
                        ) : (
                            <>
                                {/* C√≥digo de invitaci√≥n */}
                                <div className="bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl p-6 mb-6 border-2 border-purple-200">
                                    <p className="text-sm font-medium text-gray-700 mb-3 text-center">
                                        üîë C√≥digo de Invitaci√≥n
                                    </p>
                                    <div className="bg-white rounded-lg p-4 mb-4">
                                        <p className="text-3xl font-bold text-center text-purple-600 tracking-wider font-mono">
                                            {codigoSala}
                                        </p>
                                    </div>
                                    <button
                                        onClick={copiarCodigo}
                                        className="w-full bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
                                    >
                                        {copiado ? (
                                            <>
                                                <span>‚úì</span>
                                                <span>¬°Copiado!</span>
                                            </>
                                        ) : (
                                            <>
                                                <span>üìã</span>
                                                <span>Copiar C√≥digo</span>
                                            </>
                                        )}
                                    </button>
                                </div>

                                {/* Instrucciones */}
                                <div className="bg-blue-50 rounded-lg p-4 mb-6 border-l-4 border-blue-500">
                                    <p className="font-semibold text-blue-900 mb-2">üìù C√≥mo usar el c√≥digo:</p>
                                    <ol className="text-sm text-blue-800 space-y-1">
                                        <li>1. Comparte este c√≥digo con tu equipo</li>
                                        <li>2. Los usuarios deben estar registrados en Crea</li>
                                        <li>3. Al iniciar sesi√≥n, ver√°n la invitaci√≥n pendiente</li>
                                        <li>4. Pueden aceptar y unirse a la sala</li>
                                    </ol>
                                </div>

                                {/* Opciones adicionales */}
                                <div className="bg-amber-50 rounded-lg p-4 mb-6 border-l-4 border-amber-500">
                                    <p className="text-sm text-amber-800">
                                        <strong>‚ö†Ô∏è Importante:</strong> Este c√≥digo permite a cualquiera con √©l unirse a la sala. 
                                        Si crees que se ha filtrado, genera uno nuevo.
                                    </p>
                                </div>

                                {/* Botones */}
                                <div className="flex gap-3">
                                    <button
                                        onClick={regenerarCodigo}
                                        className="flex-1 px-4 py-3 border-2 border-orange-500 text-orange-600 rounded-lg hover:bg-orange-50 font-medium transition-colors"
                                    >
                                        üîÑ Regenerar C√≥digo
                                    </button>
                                    <button
                                        onClick={onCerrar}
                                        className="flex-1 gradient-bg text-white py-3 rounded-lg hover:opacity-90 font-medium transition-opacity"
                                    >
                                        Cerrar
                                    </button>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // Modal Perfil de Usuario
        // Componente Analytics View
        function AnalyticsView({ usuario }) {
            const [stats, setStats] = useState({
                colaboradoresActivos: 0,
                ideasPorEstado: {
                    incubando: 0,
                    activa: 0,
                    realizada: 0,
                    rechazada: 0,
                    expirada: 0
                },
                topColaboradores: [],
                salaMasActiva: null
            });
            const [cargando, setCargando] = useState(true);

            useEffect(() => {
                async function cargarEstadisticas() {
                    try {
                        // 1. Cargar salas del usuario
                        const salasSnapshot = await db.collection('salas')
                            .where(`miembros.${usuario.uid}`, '!=', null)
                            .get();
                        
                        const salasIds = salasSnapshot.docs.map(doc => doc.id);
                        
                        // 2. Contar colaboradores √∫nicos
                        const colaboradoresSet = new Set();
                        salasSnapshot.docs.forEach(doc => {
                            const sala = doc.data();
                            Object.keys(sala.miembros).forEach(uid => {
                                if (uid !== usuario.uid && uid !== 'anonimo') {
                                    colaboradoresSet.add(uid);
                                }
                            });
                        });
                        
                        // 3. Cargar todas las ideas de las salas del usuario
                        const ideasPromises = salasIds.map(salaId =>
                            db.collection('ideas')
                                .where('salaId', '==', salaId)
                                .where('enBasurero', '==', false)
                                .get()
                        );
                        
                        const ideasSnapshots = await Promise.all(ideasPromises);
                        const todasLasIdeas = [];
                        ideasSnapshots.forEach(snapshot => {
                            snapshot.docs.forEach(doc => {
                                todasLasIdeas.push({ id: doc.id, ...doc.data() });
                            });
                        });
                        
                        // 4. Contar ideas por estado
                        const ideasPorEstado = {
                            incubando: 0,
                            activa: 0,
                            realizada: 0,
                            rechazada: 0,
                            expirada: 0
                        };
                        
                        todasLasIdeas.forEach(idea => {
                            if (ideasPorEstado.hasOwnProperty(idea.estado)) {
                                ideasPorEstado[idea.estado]++;
                            }
                        });
                        
                        // 5. Top colaboradores (por n√∫mero de ideas)
                        const ideasPorUsuario = {};
                        todasLasIdeas.forEach(idea => {
                            if (idea.creadorId && idea.creadorId !== usuario.uid) {
                                if (!ideasPorUsuario[idea.creadorId]) {
                                    ideasPorUsuario[idea.creadorId] = {
                                        uid: idea.creadorId,
                                        nombre: idea.creadorNombre || 'Usuario',
                                        count: 0
                                    };
                                }
                                ideasPorUsuario[idea.creadorId].count++;
                            }
                        });
                        
                        const topColaboradores = Object.values(ideasPorUsuario)
                            .sort((a, b) => b.count - a.count)
                            .slice(0, 5);
                        
                        // 6. Sala m√°s activa
                        const ideasPorSala = {};
                        todasLasIdeas.forEach(idea => {
                            if (!ideasPorSala[idea.salaId]) {
                                ideasPorSala[idea.salaId] = 0;
                            }
                            ideasPorSala[idea.salaId]++;
                        });
                        
                        let salaMasActiva = null;
                        let maxIdeas = 0;
                        
                        for (const [salaId, count] of Object.entries(ideasPorSala)) {
                            if (count > maxIdeas) {
                                maxIdeas = count;
                                const salaDoc = salasSnapshot.docs.find(doc => doc.id === salaId);
                                if (salaDoc) {
                                    salaMasActiva = {
                                        nombre: salaDoc.data().nombre,
                                        count: count,
                                        color: salaDoc.data().color
                                    };
                                }
                            }
                        }
                        
                        setStats({
                            colaboradoresActivos: colaboradoresSet.size,
                            ideasPorEstado,
                            topColaboradores,
                            salaMasActiva
                        });
                        
                    } catch (err) {
                        console.error('Error al cargar estad√≠sticas:', err);
                    } finally {
                        setCargando(false);
                    }
                }
                
                cargarEstadisticas();
            }, [usuario.uid]);

            if (cargando) {
                return (
                    <div className="flex justify-center items-center py-12">
                        <div className="text-gray-500">Cargando estad√≠sticas...</div>
                    </div>
                );
            }

            const totalIdeas = Object.values(stats.ideasPorEstado).reduce((a, b) => a + b, 0);

            return (
                <div className="space-y-6">
                    <div>
                        <h3 className="text-lg font-bold text-gray-800 mb-2">üìä Estad√≠sticas</h3>
                        <p className="text-sm text-gray-600 mb-4">
                            Resumen de tu actividad en Crea
                        </p>
                    </div>

                    {/* Cards de m√©tricas */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {/* Colaboradores Activos */}
                        <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border-2 border-blue-200">
                            <div className="text-3xl mb-2">üë•</div>
                            <div className="text-3xl font-bold text-blue-900 mb-1">
                                {stats.colaboradoresActivos}
                            </div>
                            <div className="text-sm text-blue-700 font-medium">
                                Colaboradores activos
                            </div>
                            <p className="text-xs text-blue-600 mt-1">
                                Personas con las que compartes salas
                            </p>
                        </div>

                        {/* Sala m√°s activa */}
                        <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border-2 border-purple-200">
                            <div className="text-3xl mb-2">üèÜ</div>
                            {stats.salaMasActiva ? (
                                <>
                                    <div className="text-lg font-bold text-purple-900 mb-1">
                                        {stats.salaMasActiva.nombre}
                                    </div>
                                    <div className="text-sm text-purple-700 font-medium">
                                        {stats.salaMasActiva.count} ideas creadas
                                    </div>
                                    <p className="text-xs text-purple-600 mt-1">
                                        Sala m√°s activa
                                    </p>
                                </>
                            ) : (
                                <>
                                    <div className="text-lg font-bold text-purple-900 mb-1">
                                        Sin actividad
                                    </div>
                                    <p className="text-xs text-purple-600 mt-1">
                                        Crea tu primera idea
                                    </p>
                                </>
                            )}
                        </div>
                    </div>

                    {/* Distribuci√≥n de ideas */}
                    <div className="bg-white rounded-xl border-2 border-gray-200 p-6">
                        <h4 className="text-md font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span>üìà</span>
                            <span>Distribuci√≥n de Ideas</span>
                        </h4>
                        
                        {totalIdeas === 0 ? (
                            <div className="text-center py-8 text-gray-500">
                                <p className="text-2xl mb-2">üí°</p>
                                <p className="text-sm">A√∫n no hay ideas en tus salas</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {/* Incubando */}
                                <div>
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-sm font-medium text-gray-700">
                                            ü•ö Incubando
                                        </span>
                                        <span className="text-sm font-bold text-gray-900">
                                            {stats.ideasPorEstado.incubando}
                                        </span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2.5">
                                        <div
                                            className="bg-yellow-500 h-2.5 rounded-full transition-all duration-500"
                                            style={{ width: `${(stats.ideasPorEstado.incubando / totalIdeas) * 100}%` }}
                                        ></div>
                                    </div>
                                </div>

                                {/* Activas */}
                                <div>
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-sm font-medium text-gray-700">
                                            ‚ö° Activas
                                        </span>
                                        <span className="text-sm font-bold text-gray-900">
                                            {stats.ideasPorEstado.activa}
                                        </span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2.5">
                                        <div
                                            className="bg-green-500 h-2.5 rounded-full transition-all duration-500"
                                            style={{ width: `${(stats.ideasPorEstado.activa / totalIdeas) * 100}%` }}
                                        ></div>
                                    </div>
                                </div>

                                {/* Realizadas */}
                                <div>
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-sm font-medium text-gray-700">
                                            ‚úì Realizadas
                                        </span>
                                        <span className="text-sm font-bold text-gray-900">
                                            {stats.ideasPorEstado.realizada}
                                        </span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2.5">
                                        <div
                                            className="bg-blue-500 h-2.5 rounded-full transition-all duration-500"
                                            style={{ width: `${(stats.ideasPorEstado.realizada / totalIdeas) * 100}%` }}
                                        ></div>
                                    </div>
                                </div>

                                {/* Rechazadas */}
                                <div>
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-sm font-medium text-gray-700">
                                            ‚úó Rechazadas
                                        </span>
                                        <span className="text-sm font-bold text-gray-900">
                                            {stats.ideasPorEstado.rechazada}
                                        </span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2.5">
                                        <div
                                            className="bg-red-500 h-2.5 rounded-full transition-all duration-500"
                                            style={{ width: `${(stats.ideasPorEstado.rechazada / totalIdeas) * 100}%` }}
                                        ></div>
                                    </div>
                                </div>

                                {/* Expiradas */}
                                <div>
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-sm font-medium text-gray-700">
                                            ‚è∞ Expiradas
                                        </span>
                                        <span className="text-sm font-bold text-gray-900">
                                            {stats.ideasPorEstado.expirada}
                                        </span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2.5">
                                        <div
                                            className="bg-gray-500 h-2.5 rounded-full transition-all duration-500"
                                            style={{ width: `${(stats.ideasPorEstado.expirada / totalIdeas) * 100}%` }}
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Top 5 colaboradores */}
                    {stats.topColaboradores.length > 0 && (
                        <div className="bg-white rounded-xl border-2 border-gray-200 p-6">
                            <h4 className="text-md font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <span>üåü</span>
                                <span>Top Colaboradores</span>
                            </h4>
                            
                            <div className="space-y-3">
                                {stats.topColaboradores.map((colaborador, index) => (
                                    <div key={colaborador.uid} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                        <div className="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold text-sm">
                                            {index + 1}
                                        </div>
                                        <div className="flex-1">
                                            <div className="font-medium text-gray-900">{colaborador.nombre}</div>
                                            <div className="text-xs text-gray-600">{colaborador.count} ideas creadas</div>
                                        </div>
                                        <div className="text-2xl">
                                            {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '‚≠ê'}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Nota al pie */}
                    <div className="bg-purple-50 border-l-4 border-purple-500 p-4 rounded">
                        <p className="text-sm text-purple-800">
                            <strong>üí° Nota:</strong> Estas estad√≠sticas muestran √∫nicamente la actividad en salas compartidas, no incluyen m√©tricas estresantes como tasas de aprobaci√≥n o totales hist√≥ricos.
                        </p>
                    </div>
                </div>
            );
        }

        // Modal Feed P√∫blico
        function ModalFeedPublico({ usuario, onCerrar }) {
            const [salasPublicas, setSalasPublicas] = useState([]);
            const [amigosIds, setAmigosIds] = useState([]);
            const [cargando, setCargando] = useState(true);
            const [salaSeleccionada, setSalaSeleccionada] = useState(null);

            useEffect(() => {
                cargarSalasPublicas();
            }, []);

            async function cargarSalasPublicas() {
                try {
                    // Obtener IDs de amigos
                    const amistades1 = await db.collection('amistades')
                        .where('emisorId', '==', usuario.uid)
                        .where('estado', '==', ESTADO_AMISTAD.ACEPTADA)
                        .get();
                    
                    const amistades2 = await db.collection('amistades')
                        .where('receptorId', '==', usuario.uid)
                        .where('estado', '==', ESTADO_AMISTAD.ACEPTADA)
                        .get();
                    
                    const amigosSet = new Set();
                    amistades1.docs.forEach(doc => amigosSet.add(doc.data().receptorId));
                    amistades2.docs.forEach(doc => amigosSet.add(doc.data().emisorId));
                    setAmigosIds(Array.from(amigosSet));
                    
                    // Obtener salas p√∫blicas
                    const salasSnapshot = await db.collection('salas')
                        .where('visibilidad', '==', VISIBILIDAD.PUBLICA)
                        .get();
                    
                    const salas = salasSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // Filtrar por audiencia y excluir salas donde ya soy miembro
                    const salasFiltradas = salas.filter(sala => {
                        // Excluir si ya soy miembro
                        if (sala.miembros && sala.miembros[usuario.uid]) return false;
                        
                        // Si es todo p√∫blico, mostrar
                        if (sala.audiencia === AUDIENCIA.TODO_PUBLICO) return true;
                        
                        // Si es solo amigos, verificar amistad
                        if (sala.audiencia === AUDIENCIA.SOLO_AMIGOS) {
                            return amigosSet.has(sala.creadorId);
                        }
                        
                        return false;
                    });
                    
                    setSalasPublicas(salasFiltradas);
                } catch (err) {
                    console.error('Error al cargar salas p√∫blicas:', err);
                } finally {
                    setCargando(false);
                }
            }

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                        {/* Header */}
                        <div className="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-gray-800">üåê Explorar Salas P√∫blicas</h2>
                            <button
                                onClick={onCerrar}
                                className="text-gray-400 hover:text-gray-600 text-2xl"
                            >
                                √ó
                            </button>
                        </div>

                        {/* Contenido */}
                        <div className="p-6 overflow-y-auto flex-1">
                            {cargando ? (
                                <div className="text-center py-12">
                                    <div className="text-4xl mb-2">‚è≥</div>
                                    <p className="text-gray-600">Cargando salas p√∫blicas...</p>
                                </div>
                            ) : salasPublicas.length === 0 ? (
                                <div className="text-center py-12">
                                    <div className="text-6xl mb-4">üîç</div>
                                    <p className="text-xl text-gray-600 mb-2">No hay salas p√∫blicas disponibles</p>
                                    <p className="text-sm text-gray-500">¬°S√© el primero en crear una sala p√∫blica!</p>
                                </div>
                            ) : (
                                <div className="grid gap-4">
                                    {salasPublicas.map(sala => (
                                        <SalaPublicaCard
                                            key={sala.id}
                                            sala={sala}
                                            usuario={usuario}
                                            esAmigo={amigosIds.includes(sala.creadorId)}
                                            onSeleccionar={() => setSalaSeleccionada(sala)}
                                        />
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Modal de Sala Seleccionada */}
                    {salaSeleccionada && (
                        <ModalDetalleSalaPublica
                            sala={salaSeleccionada}
                            usuario={usuario}
                            onCerrar={() => setSalaSeleccionada(null)}
                        />
                    )}
                </div>
            );
        }

        // Card de Sala P√∫blica
        function SalaPublicaCard({ sala, usuario, esAmigo, onSeleccionar }) {
            const audienciaLabel = sala.audiencia === AUDIENCIA.TODO_PUBLICO ? 'üåç Todo P√∫blico' : 'üë• Solo Amigos';
            const nivelLabel = {
                [NIVEL_INTERACCION.SOLO_LECTURA]: 'üëÅÔ∏è Solo Lectura',
                [NIVEL_INTERACCION.COMENTARIOS_REACCIONES]: 'üí¨ Comentarios y Reacciones',
                [NIVEL_INTERACCION.FULL_INTERACCION]: '‚ö° Interacci√≥n Completa'
            }[sala.nivelInteraccion];

            return (
                <div className="border-2 border-gray-200 rounded-lg p-4 hover:border-purple-300 transition-colors bg-white">
                    <div className="flex items-start justify-between mb-3">
                        <div className="flex-1">
                            <h3 className="text-lg font-bold text-gray-800 mb-1">
                                üåê {sala.nombre}
                            </h3>
                            <p className="text-sm text-gray-600">
                                Por: <span className="font-medium">{sala.creadorNombre}</span>
                                {esAmigo && <span className="ml-2 text-purple-600">üë§ Amigo</span>}
                            </p>
                        </div>
                        <button
                            onClick={onSeleccionar}
                            className="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm font-medium transition-colors"
                        >
                            Ver Ideas
                        </button>
                    </div>
                    
                    <div className="flex gap-2 text-xs">
                        <span className="px-2 py-1 bg-purple-100 text-purple-700 rounded">
                            {audienciaLabel}
                        </span>
                        <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded">
                            {nivelLabel}
                        </span>
                    </div>
                </div>
            );
        }

        // Modal Detalle de Sala P√∫blica
        function ModalDetalleSalaPublica({ sala, usuario, onCerrar }) {
            const [ideas, setIdeas] = useState([]);
            const [cargando, setCargando] = useState(true);

            useEffect(() => {
                cargarIdeas();
            }, [sala.id]);

            async function cargarIdeas() {
                try {
                    const ideasSnapshot = await db.collection('ideas')
                        .where('salaId', '==', sala.id)
                        .where('estado', 'in', [ESTADOS.INCUBANDO, ESTADOS.ACTIVA, ESTADOS.REALIZADA])
                        .get();
                    
                    const ideasData = ideasSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        createdAt: doc.data().createdAt?.toMillis() || Date.now()
                    }));
                    
                    ideasData.sort((a, b) => b.createdAt - a.createdAt);
                    setIdeas(ideasData);
                } catch (err) {
                    console.error('Error al cargar ideas:', err);
                } finally {
                    setCargando(false);
                }
            }

            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                        {/* Header */}
                        <div className="sticky top-0 bg-white border-b p-6">
                            <div className="flex justify-between items-start mb-3">
                                <div className="flex-1">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-2">
                                        üåê {sala.nombre}
                                    </h2>
                                    <p className="text-sm text-gray-600">
                                        Por: <span className="font-medium">{sala.creadorNombre}</span>
                                    </p>
                                </div>
                                <button
                                    onClick={onCerrar}
                                    className="text-gray-400 hover:text-gray-600 text-2xl"
                                >
                                    √ó
                                </button>
                            </div>
                            
                            <div className="flex gap-2 text-xs">
                                <span className="px-2 py-1 bg-purple-100 text-purple-700 rounded">
                                    {sala.audiencia === AUDIENCIA.TODO_PUBLICO ? 'üåç Todo P√∫blico' : 'üë• Solo Amigos'}
                                </span>
                                <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded">
                                    {sala.nivelInteraccion === NIVEL_INTERACCION.SOLO_LECTURA && 'üëÅÔ∏è Solo Lectura'}
                                    {sala.nivelInteraccion === NIVEL_INTERACCION.COMENTARIOS_REACCIONES && 'üí¨ Comentarios'}
                                    {sala.nivelInteraccion === NIVEL_INTERACCION.FULL_INTERACCION && '‚ö° Full'}
                                </span>
                            </div>
                        </div>

                        {/* Ideas */}
                        <div className="p-6 overflow-y-auto flex-1">
                            {cargando ? (
                                <div className="text-center py-8">
                                    <p className="text-gray-600">Cargando ideas...</p>
                                </div>
                            ) : (
                                <IdeaListPublica
                                    ideas={ideas}
                                    nivelInteraccion={sala.nivelInteraccion}
                                />
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Lista de Ideas P√∫blicas
        function IdeaListPublica({ ideas, nivelInteraccion }) {
            function getEstadoLabel(estado) {
                const labels = {
                    incubando: 'ü•ö Incubando',
                    activa: '‚ö° Activa',
                    realizada: '‚úì Realizada',
                    rechazada: '‚úó Rechazada',
                    expirada: '‚è∞ Expirada'
                };
                return labels[estado] || estado;
            }

            if (ideas.length === 0) {
                return (
                    <div className="text-center py-8 text-gray-500">
                        <div className="text-4xl mb-2">üí≠</div>
                        <p>No hay ideas a√∫n en esta sala</p>
                    </div>
                );
            }

            return (
                <div className="space-y-3">
                    {ideas.map(idea => (
                        <div key={idea.id} className="p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <div className="flex items-start justify-between mb-2">
                                <div className="flex-1">
                                    <p className="text-gray-800 mb-2">{idea.texto}</p>
                                    <div className="flex items-center gap-3 text-sm text-gray-500">
                                        <span>üë§ {idea.creadorNombre}</span>
                                        <span>{getEstadoLabel(idea.estado)}</span>
                                    </div>
                                </div>
                            </div>
                            {nivelInteraccion !== NIVEL_INTERACCION.SOLO_LECTURA && (
                                <div className="flex gap-4 mt-3 text-sm text-gray-500">
                                    <span>
                                        ‚ù§Ô∏è {Object.keys(idea.reaccionesPorUsuario || {}).length} reacciones
                                    </span>
                                    <span>
                                        üí¨ {(idea.comentarios || []).length} comentarios
                                    </span>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            );
        }

        function ModalPerfil({ usuario, onCerrar }) {
            const [nombre, setNombre] = useState(usuario.nombre);
            const [passwordActual, setPasswordActual] = useState('');
            const [passwordNueva, setPasswordNueva] = useState('');
            const [passwordConfirmar, setPasswordConfirmar] = useState('');
            const [cargando, setCargando] = useState(false);
            const [error, setError] = useState('');
            const [exito, setExito] = useState('');
            const [tab, setTab] = useState('general'); // 'general', 'seguridad', 'contactos', 'amigos', 'estadisticas'
            const [colaboradores, setColaboradores] = useState([]);
            const [solicitudesAmistad, setSolicitudesAmistad] = useState([]);
            const [amigos, setAmigos] = useState([]);
            const [busquedaEmail, setBusquedaEmail] = useState('');

            // Cargar solicitudes y amigos
            useEffect(() => {
                cargarAmistades();
            }, [usuario.uid]);

            async function cargarAmistades() {
                try {
                    // Cargar solicitudes pendientes recibidas
                    const solicitudesSnapshot = await db.collection('amistades')
                        .where('receptorId', '==', usuario.uid)
                        .where('estado', '==', ESTADO_AMISTAD.PENDIENTE)
                        .get();
                    
                    const solicitudesData = await Promise.all(
                        solicitudesSnapshot.docs.map(async (doc) => {
                            const data = doc.data();
                            const emisorDoc = await db.collection('usuarios').doc(data.emisorId).get();
                            return {
                                id: doc.id,
                                ...data,
                                emisorNombre: emisorDoc.data()?.nombre || 'Usuario',
                                emisorEmail: emisorDoc.data()?.email || ''
                            };
                        })
                    );
                    setSolicitudesAmistad(solicitudesData);
                    
                    // Cargar amigos aceptados (donde soy emisor o receptor)
                    const amigosComoEmisor = await db.collection('amistades')
                        .where('emisorId', '==', usuario.uid)
                        .where('estado', '==', ESTADO_AMISTAD.ACEPTADA)
                        .get();
                    
                    const amigosComoReceptor = await db.collection('amistades')
                        .where('receptorId', '==', usuario.uid)
                        .where('estado', '==', ESTADO_AMISTAD.ACEPTADA)
                        .get();
                    
                    const amigosData = [];
                    
                    for (const doc of amigosComoEmisor.docs) {
                        const data = doc.data();
                        const amigoDoc = await db.collection('usuarios').doc(data.receptorId).get();
                        amigosData.push({
                            id: doc.id,
                            uid: data.receptorId,
                            nombre: amigoDoc.data()?.nombre || 'Usuario',
                            email: amigoDoc.data()?.email || ''
                        });
                    }
                    
                    for (const doc of amigosComoReceptor.docs) {
                        const data = doc.data();
                        const amigoDoc = await db.collection('usuarios').doc(data.emisorId).get();
                        amigosData.push({
                            id: doc.id,
                            uid: data.emisorId,
                            nombre: amigoDoc.data()?.nombre || 'Usuario',
                            email: amigoDoc.data()?.email || ''
                        });
                    }
                    
                    setAmigos(amigosData);
                } catch (err) {
                    console.error('Error al cargar amistades:', err);
                }
            }

            async function enviarSolicitudAmistad() {
                if (!busquedaEmail.trim()) return;
                
                try {
                    setCargando(true);
                    setError('');
                    setExito('');
                    
                    // Buscar usuario por email
                    const usuarioSnapshot = await db.collection('usuarios')
                        .where('email', '==', busquedaEmail.trim().toLowerCase())
                        .get();
                    
                    if (usuarioSnapshot.empty) {
                        setError('No se encontr√≥ ning√∫n usuario con ese email');
                        setCargando(false);
                        return;
                    }
                    
                    const receptorDoc = usuarioSnapshot.docs[0];
                    const receptorId = receptorDoc.id;
                    
                    if (receptorId === usuario.uid) {
                        setError('No puedes enviarte una solicitud a ti mismo');
                        setCargando(false);
                        return;
                    }
                    
                    // Verificar si ya son amigos o hay solicitud pendiente
                    const amistadExistente = await db.collection('amistades')
                        .where('emisorId', 'in', [usuario.uid, receptorId])
                        .where('receptorId', 'in', [usuario.uid, receptorId])
                        .get();
                    
                    if (!amistadExistente.empty) {
                        setError('Ya existe una solicitud o son amigos');
                        setCargando(false);
                        return;
                    }
                    
                    // Crear solicitud
                    await db.collection('amistades').add({
                        emisorId: usuario.uid,
                        emisorNombre: usuario.nombre,
                        receptorId: receptorId,
                        receptorNombre: receptorDoc.data().nombre,
                        estado: ESTADO_AMISTAD.PENDIENTE,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setExito('¬°Solicitud enviada!');
                    setBusquedaEmail('');
                    setTimeout(() => setExito(''), 3000);
                } catch (err) {
                    console.error('Error al enviar solicitud:', err);
                    setError('Error al enviar la solicitud');
                } finally {
                    setCargando(false);
                }
            }

            async function aceptarSolicitud(solicitudId) {
                try {
                    await db.collection('amistades').doc(solicitudId).update({
                        estado: ESTADO_AMISTAD.ACEPTADA,
                        aceptadaEn: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await cargarAmistades();
                } catch (err) {
                    console.error('Error al aceptar solicitud:', err);
                }
            }

            async function rechazarSolicitud(solicitudId) {
                try {
                    await db.collection('amistades').doc(solicitudId).delete();
                    await cargarAmistades();
                } catch (err) {
                    console.error('Error al rechazar solicitud:', err);
                }
            }

            async function eliminarAmigo(amistadId) {
                if (confirm('¬øEliminar este contacto?')) {
                    try {
                        await db.collection('amistades').doc(amistadId).delete();
                        await cargarAmistades();
                    } catch (err) {
                        console.error('Error al eliminar amigo:', err);
                    }
                }
            }

            // Cargar colaboradores (usuarios con salas en com√∫n)
            useEffect(() => {
                async function cargarColaboradores() {
                    try {
                        // Obtener todas las salas del usuario
                        const salasSnapshot = await db.collection('salas')
                            .where(`miembros.${usuario.uid}`, '!=', null)
                            .get();
                        
                        const usuariosUnicos = new Set();
                        const usuariosInfo = {};
                        
                        // Recopilar todos los miembros
                        salasSnapshot.docs.forEach(doc => {
                            const sala = doc.data();
                            Object.entries(sala.miembros).forEach(([uid, rol]) => {
                                if (uid !== usuario.uid && uid !== 'anonimo') {
                                    usuariosUnicos.add(uid);
                                    if (!usuariosInfo[uid]) {
                                        usuariosInfo[uid] = {
                                            uid: uid,
                                            nombre: Object.keys(sala.miembros).includes(uid) ? 
                                                   (sala.creadorNombre || 'Usuario') : 'Usuario',
                                            salasComunes: []
                                        };
                                    }
                                    usuariosInfo[uid].salasComunes.push({
                                        nombre: sala.nombre,
                                        rol: rol
                                    });
                                }
                            });
                        });
                        
                        // Obtener nombres y emails reales de Firestore users y usuarios
                        const colaboradoresConNombres = await Promise.all(
                            Array.from(usuariosUnicos).map(async (uid) => {
                                try {
                                    // Intentar primero en 'users'
                                    let userDoc = await db.collection('users').doc(uid).get();
                                    
                                    // Si no existe, intentar en 'usuarios'
                                    if (!userDoc.exists) {
                                        userDoc = await db.collection('usuarios').doc(uid).get();
                                    }
                                    
                                    if (userDoc.exists) {
                                        const userData = userDoc.data();
                                        return {
                                            ...usuariosInfo[uid],
                                            nombre: userData.nombre || 'Usuario',
                                            email: userData.email || 'Email no disponible'
                                        };
                                    }
                                    
                                    return {
                                        ...usuariosInfo[uid],
                                        email: 'Email no disponible'
                                    };
                                } catch (err) {
                                    return {
                                        ...usuariosInfo[uid],
                                        email: 'Email no disponible'
                                    };
                                }
                            })
                        );
                        
                        setColaboradores(colaboradoresConNombres);
                    } catch (err) {
                        console.error('Error al cargar colaboradores:', err);
                    }
                }
                
                cargarColaboradores();
            }, [usuario.uid]);

            async function actualizarNombre() {
                if (!nombre.trim()) {
                    setError('El nombre no puede estar vac√≠o');
                    return;
                }
                
                setCargando(true);
                setError('');
                setExito('');
                
                try {
                    await db.collection('users').doc(usuario.uid).update({
                        nombre: nombre.trim()
                    });
                    
                    setExito('‚úÖ Nombre actualizado correctamente');
                } catch (err) {
                    setError('Error al actualizar nombre: ' + err.message);
                }
                
                setCargando(false);
            }

            async function cambiarPassword() {
                setError('');
                setExito('');
                
                if (!passwordActual || !passwordNueva || !passwordConfirmar) {
                    setError('Completa todos los campos');
                    return;
                }
                
                if (passwordNueva.length < 6) {
                    setError('La nueva contrase√±a debe tener al menos 6 caracteres');
                    return;
                }
                
                if (passwordNueva !== passwordConfirmar) {
                    setError('Las contrase√±as nuevas no coinciden');
                    return;
                }
                
                setCargando(true);
                
                try {
                    // Reautenticar usuario
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        auth.currentUser.email,
                        passwordActual
                    );
                    await auth.currentUser.reauthenticateWithCredential(credential);
                    
                    // Cambiar contrase√±a
                    await auth.currentUser.updatePassword(passwordNueva);
                    
                    setExito('‚úÖ Contrase√±a cambiada correctamente');
                    setPasswordActual('');
                    setPasswordNueva('');
                    setPasswordConfirmar('');
                } catch (err) {
                    if (err.code === 'auth/wrong-password') {
                        setError('La contrase√±a actual es incorrecta');
                    } else {
                        setError('Error al cambiar contrase√±a: ' + err.message);
                    }
                }
                
                setCargando(false);
            }

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onCerrar}>
                    <div 
                        className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Header */}
                        <div className="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-gray-800">üë§ Mi Perfil</h2>
                            <button
                                onClick={onCerrar}
                                className="text-gray-400 hover:text-gray-600 text-2xl"
                            >
                                √ó
                            </button>
                        </div>

                        {/* Tabs */}
                        <div className="border-b">
                            <div className="flex">
                                <button
                                    onClick={() => setTab('general')}
                                    className={`flex-1 px-4 py-3 font-medium transition-colors ${
                                        tab === 'general'
                                            ? 'border-b-2 border-purple-500 text-purple-600'
                                            : 'text-gray-600 hover:bg-gray-50'
                                    }`}
                                >
                                    üìù General
                                </button>
                                <button
                                    onClick={() => setTab('seguridad')}
                                    className={`flex-1 px-4 py-3 font-medium transition-colors ${
                                        tab === 'seguridad'
                                            ? 'border-b-2 border-purple-500 text-purple-600'
                                            : 'text-gray-600 hover:bg-gray-50'
                                    }`}
                                >
                                    üîê Seguridad
                                </button>
                                <button
                                    onClick={() => setTab('contactos')}
                                    className={`flex-1 px-4 py-3 font-medium transition-colors ${
                                        tab === 'contactos'
                                            ? 'border-b-2 border-purple-500 text-purple-600'
                                            : 'text-gray-600 hover:bg-gray-50'
                                    }`}
                                >
                                    üë• Contactos ({colaboradores.length})
                                </button>
                                <button
                                    onClick={() => setTab('amigos')}
                                    className={`flex-1 px-4 py-3 font-medium transition-colors ${
                                        tab === 'amigos'
                                            ? 'border-b-2 border-purple-500 text-purple-600'
                                            : 'text-gray-600 hover:bg-gray-50'
                                    }`}
                                >
                                    ü§ù Amigos ({amigos.length})
                                </button>
                                <button
                                    onClick={() => setTab('analytics')}
                                    className={`flex-1 px-4 py-3 font-medium transition-colors ${
                                        tab === 'analytics'
                                            ? 'border-b-2 border-purple-500 text-purple-600'
                                            : 'text-gray-600 hover:bg-gray-50'
                                    }`}
                                >
                                    üìä Estad√≠sticas
                                </button>
                            </div>
                        </div>

                        {/* Contenido */}
                        <div className="p-6">
                            {error && (
                                <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                                    <p className="text-red-700 text-sm">{error}</p>
                                </div>
                            )}

                            {exito && (
                                <div className="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                                    <p className="text-green-700 text-sm">{exito}</p>
                                </div>
                            )}

                            {/* Tab General */}
                            {tab === 'general' && (
                                <div className="space-y-6">
                                    <div>
                                        <h3 className="text-lg font-bold text-gray-800 mb-4">Informaci√≥n Personal</h3>
                                        
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Nombre
                                                </label>
                                                <input
                                                    type="text"
                                                    value={nombre}
                                                    onChange={(e) => setNombre(e.target.value)}
                                                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none"
                                                    placeholder="Tu nombre"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Email
                                                </label>
                                                <input
                                                    type="email"
                                                    value={auth.currentUser?.email || ''}
                                                    disabled
                                                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg bg-gray-50 text-gray-500"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">
                                                    El email no se puede cambiar
                                                </p>
                                            </div>

                                            <button
                                                onClick={actualizarNombre}
                                                disabled={cargando || nombre === usuario.nombre}
                                                className="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-lg font-medium disabled:bg-gray-300 disabled:cursor-not-allowed"
                                            >
                                                {cargando ? 'Guardando...' : 'Guardar Cambios'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Tab Seguridad */}
                            {tab === 'seguridad' && (
                                <div className="space-y-6">
                                    <div>
                                        <h3 className="text-lg font-bold text-gray-800 mb-4">Cambiar Contrase√±a</h3>
                                        
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Contrase√±a Actual
                                                </label>
                                                <input
                                                    type="password"
                                                    value={passwordActual}
                                                    onChange={(e) => setPasswordActual(e.target.value)}
                                                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none"
                                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Nueva Contrase√±a
                                                </label>
                                                <input
                                                    type="password"
                                                    value={passwordNueva}
                                                    onChange={(e) => setPasswordNueva(e.target.value)}
                                                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none"
                                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Confirmar Nueva Contrase√±a
                                                </label>
                                                <input
                                                    type="password"
                                                    value={passwordConfirmar}
                                                    onChange={(e) => setPasswordConfirmar(e.target.value)}
                                                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none"
                                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                                />
                                            </div>

                                            <button
                                                onClick={cambiarPassword}
                                                disabled={cargando}
                                                className="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-lg font-medium disabled:bg-gray-300 disabled:cursor-not-allowed"
                                            >
                                                {cargando ? 'Cambiando...' : 'Cambiar Contrase√±a'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Tab Contactos */}
                            {tab === 'contactos' && (
                                <div className="space-y-4">
                                    <div>
                                        <h3 className="text-lg font-bold text-gray-800 mb-2">Colaboradores</h3>
                                        <p className="text-sm text-gray-600 mb-4">
                                            Personas con las que compartes salas
                                        </p>
                                    </div>

                                    {colaboradores.length === 0 ? (
                                        <div className="text-center py-8 text-gray-500">
                                            <p className="text-4xl mb-2">üë•</p>
                                            <p>A√∫n no tienes colaboradores</p>
                                            <p className="text-sm mt-1">Invita personas a tus salas para empezar</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {colaboradores.map(colaborador => (
                                                <div key={colaborador.uid} className="bg-gray-50 rounded-lg p-4 border-2 border-gray-100">
                                                    <div className="flex items-start justify-between">
                                                        <div className="flex-1">
                                                            <h4 className="font-bold text-gray-800">{colaborador.nombre}</h4>
                                                            <p className="text-sm text-gray-600 mt-0.5">
                                                                üìß {colaborador.email}
                                                            </p>
                                                            <p className="text-xs text-gray-500 mt-1">
                                                                {colaborador.salasComunes.length} sala{colaborador.salasComunes.length !== 1 ? 's' : ''} en com√∫n
                                                            </p>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Salas en com√∫n */}
                                                    <details className="mt-3">
                                                        <summary className="cursor-pointer text-sm text-purple-600 hover:text-purple-700 font-medium">
                                                            Ver salas compartidas
                                                        </summary>
                                                        <div className="mt-2 space-y-1">
                                                            {colaborador.salasComunes.map((sala, idx) => (
                                                                <div key={idx} className="text-sm text-gray-600 pl-4">
                                                                    ‚Ä¢ <strong>{sala.nombre}</strong> 
                                                                    <span className="text-xs text-gray-500"> ({sala.rol})</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </details>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Tab Amigos */}
                            {tab === 'amigos' && (
                                <div className="space-y-6">
                                    {/* Agregar Nuevo Amigo */}
                                    <div className="border-b pb-6">
                                        <h3 className="text-lg font-semibold text-gray-800 mb-4">
                                            ‚ûï Agregar Amigo
                                        </h3>
                                        <div className="flex gap-2">
                                            <input
                                                type="email"
                                                value={busquedaEmail}
                                                onChange={(e) => setBusquedaEmail(e.target.value)}
                                                placeholder="email@ejemplo.com"
                                                className="flex-1 px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none"
                                            />
                                            <button
                                                onClick={enviarSolicitudAmistad}
                                                disabled={cargando || !busquedaEmail.trim()}
                                                className="px-6 py-2 gradient-bg text-white rounded-lg hover:opacity-90 disabled:opacity-50"
                                            >
                                                Enviar Solicitud
                                            </button>
                                        </div>
                                    </div>

                                    {/* Solicitudes Pendientes */}
                                    {solicitudesAmistad.length > 0 && (
                                        <div className="border-b pb-6">
                                            <h3 className="text-lg font-semibold text-gray-800 mb-4">
                                                üì¨ Solicitudes Pendientes ({solicitudesAmistad.length})
                                            </h3>
                                            <div className="space-y-2">
                                                {solicitudesAmistad.map(solicitud => (
                                                    <div key={solicitud.id} className="flex items-center justify-between p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                                                        <div>
                                                            <div className="font-medium text-gray-800">{solicitud.emisorNombre}</div>
                                                            <div className="text-sm text-gray-600">{solicitud.emisorEmail}</div>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => aceptarSolicitud(solicitud.id)}
                                                                className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm"
                                                            >
                                                                ‚úì Aceptar
                                                            </button>
                                                            <button
                                                                onClick={() => rechazarSolicitud(solicitud.id)}
                                                                className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm"
                                                            >
                                                                ‚úó Rechazar
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* Lista de Amigos */}
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-800 mb-4">
                                            üë• Mis Amigos ({amigos.length})
                                        </h3>
                                        {amigos.length === 0 ? (
                                            <div className="text-center py-8 text-gray-500">
                                                <div className="text-4xl mb-2">üëã</div>
                                                <p>A√∫n no tienes amigos agregados</p>
                                                <p className="text-sm mt-1">Env√≠a solicitudes por email</p>
                                            </div>
                                        ) : (
                                            <div className="space-y-2">
                                                {amigos.map(amigo => (
                                                    <div key={amigo.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                        <div>
                                                            <div className="font-medium text-gray-800">{amigo.nombre}</div>
                                                            <div className="text-sm text-gray-600">{amigo.email}</div>
                                                        </div>
                                                        <button
                                                            onClick={() => eliminarAmigo(amigo.id)}
                                                            className="px-3 py-1 text-sm text-red-600 hover:bg-red-50 rounded"
                                                        >
                                                            Eliminar
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Tab Analytics */}
                            {tab === 'analytics' && (
                                <AnalyticsView usuario={usuario} />
                            )}
                        </div>

                        {/* Footer */}
                        <div className="sticky bottom-0 bg-gray-50 border-t p-4">
                            <button
                                onClick={() => auth.signOut()}
                                className="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg font-medium"
                            >
                                üö™ Cerrar Sesi√≥n
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Modal Aprobar Idea
        function ModalAprobarIdea({ idea, onAprobar, onCerrar }) {
            const [textoFinal, setTextoFinal] = useState(idea.texto);
            const [usarTextoOriginal, setUsarTextoOriginal] = useState(true);
            const MAX_CHARS = 500;

            function handleAprobar() {
                if (usarTextoOriginal) {
                    onAprobar(idea.id, '');
                } else {
                    if (textoFinal.trim()) {
                        onAprobar(idea.id, textoFinal.trim());
                    }
                }
                onCerrar();
            }

            const tienePropuestasAceptadas = (idea.comentarios || []).some(
                c => c.esPropuesta && c.estado === 'aceptada'
            );

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onCerrar}>
                    <div 
                        className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl fade-in max-h-[90vh] overflow-y-auto"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="flex justify-between items-start mb-4">
                            <h2 className="text-2xl font-bold text-gray-800">
                                ‚úì Aprobar Idea
                            </h2>
                            <button
                                onClick={onCerrar}
                                className="text-gray-400 hover:text-gray-600 text-2xl"
                            >
                                √ó
                            </button>
                        </div>

                        {/* Idea original */}
                        <div className="mb-4">
                            <h3 className="text-sm font-bold text-gray-600 uppercase mb-2">Idea original:</h3>
                            <div className="bg-gray-50 rounded-lg p-4 border-l-4 border-gray-300">
                                <p className="text-gray-700">{idea.texto}</p>
                            </div>
                        </div>

                        {/* Propuestas aceptadas */}
                        {tienePropuestasAceptadas && (
                            <div className="mb-4">
                                <h3 className="text-sm font-bold text-green-600 uppercase mb-2">
                                    üí° Propuestas aceptadas:
                                </h3>
                                <div className="space-y-2">
                                    {(idea.comentarios || [])
                                        .filter(c => c.esPropuesta && c.estado === 'aceptada')
                                        .map(comentario => (
                                            <div key={comentario.id} className="bg-green-50 rounded-lg p-3 border-l-4 border-green-400">
                                                <p className="text-sm text-gray-600 mb-1">
                                                    Por: <strong>{comentario.autorNombre}</strong>
                                                </p>
                                                <p className="text-gray-700">{comentario.texto}</p>
                                            </div>
                                        ))}
                                </div>
                            </div>
                        )}

                        {/* Opciones */}
                        <div className="mb-4">
                            <label className="flex items-start gap-3 p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors mb-3"
                                   style={{ borderColor: usarTextoOriginal ? '#667eea' : '#e5e7eb' }}>
                                <input
                                    type="radio"
                                    name="textoOption"
                                    checked={usarTextoOriginal}
                                    onChange={() => setUsarTextoOriginal(true)}
                                    className="mt-1"
                                />
                                <div className="flex-1">
                                    <span className="font-medium text-gray-800">Usar texto original</span>
                                    <p className="text-sm text-gray-600 mt-1">
                                        La idea se aprobar√° tal como est√°
                                    </p>
                                </div>
                            </label>

                            <label className="flex items-start gap-3 p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors"
                                   style={{ borderColor: !usarTextoOriginal ? '#667eea' : '#e5e7eb' }}>
                                <input
                                    type="radio"
                                    name="textoOption"
                                    checked={!usarTextoOriginal}
                                    onChange={() => setUsarTextoOriginal(false)}
                                    className="mt-1"
                                />
                                <div className="flex-1">
                                    <span className="font-medium text-gray-800">Redactar versi√≥n final</span>
                                    <p className="text-sm text-gray-600 mt-1">
                                        {tienePropuestasAceptadas 
                                            ? 'Incorpora las propuestas aceptadas en una versi√≥n final'
                                            : 'Edita el texto antes de aprobar'}
                                    </p>
                                </div>
                            </label>
                        </div>

                        {/* Editor de texto final */}
                        {!usarTextoOriginal && (
                            <div className="mb-4">
                                <h3 className="text-sm font-bold text-purple-600 uppercase mb-2">
                                    ‚úçÔ∏è Versi√≥n final aprobada:
                                </h3>
                                <textarea
                                    value={textoFinal}
                                    onChange={(e) => setTextoFinal(e.target.value.slice(0, MAX_CHARS))}
                                    placeholder="Escribe la versi√≥n final de la idea..."
                                    className="w-full p-4 border-2 border-purple-200 rounded-lg focus:border-purple-500 focus:outline-none resize-none text-base"
                                    rows="5"
                                    style={{ fontSize: '16px' }}
                                />
                                <div className="flex justify-between items-center mt-2">
                                    <span className="text-sm text-gray-500">
                                        {textoFinal.length}/{MAX_CHARS} caracteres
                                    </span>
                                    {textoFinal !== idea.texto && (
                                        <span className="text-xs text-purple-600 font-medium">
                                            ‚úèÔ∏è Texto editado
                                        </span>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Botones */}
                        <div className="flex gap-3 mt-6">
                            <button
                                onClick={onCerrar}
                                className="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium"
                            >
                                Cancelar
                            </button>
                            <button
                                onClick={handleAprobar}
                                disabled={!usarTextoOriginal && textoFinal.trim().length === 0}
                                className="flex-1 px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 font-medium disabled:bg-gray-300 disabled:cursor-not-allowed"
                            >
                                ‚úì Aprobar Idea
                            </button>
                        </div>

                        {!usarTextoOriginal && (
                            <p className="text-xs text-gray-500 text-center mt-3">
                                üí° El texto original se guardar√° para referencia
                            </p>
                        )}
                    </div>
                </div>
            );
        }

        // Modal Exportar
        function ModalExportar({ salas, salaActual, ideas, usuario, onCerrar }) {
            const [formato, setFormato] = useState('pdf'); // 'pdf' o 'csv'
            const [tipoExportacion, setTipoExportacion] = useState('ideas'); // 'ideas' o 'analytics'
            const [filtroEstado, setFiltroEstado] = useState('todos');
            const [filtroSala, setFiltroSala] = useState(salaActual || 'todas');
            const [fechaDesde, setFechaDesde] = useState('');
            const [fechaHasta, setFechaHasta] = useState('');
            const [cargando, setCargando] = useState(false);

            async function handleExportar() {
                setCargando(true);
                
                try {
                    if (tipoExportacion === 'ideas') {
                        await exportarIdeas();
                    } else {
                        await exportarAnalytics();
                    }
                } catch (err) {
                    console.error('Error al exportar:', err);
                    alert('Error al generar el archivo. Por favor intenta de nuevo.');
                } finally {
                    setCargando(false);
                }
            }

            async function exportarIdeas() {
                // Filtrar ideas seg√∫n los criterios
                let ideasFiltradas = ideas.filter(i => i.estado !== ESTADOS.ELIMINADA);
                
                // Filtro por sala
                if (filtroSala !== 'todas') {
                    ideasFiltradas = ideasFiltradas.filter(i => i.salaId === filtroSala);
                }
                
                // Filtro por estado
                if (filtroEstado !== 'todos') {
                    ideasFiltradas = ideasFiltradas.filter(i => i.estado === filtroEstado);
                }
                
                // Filtro por fecha
                if (fechaDesde) {
                    const desde = new Date(fechaDesde).getTime();
                    ideasFiltradas = ideasFiltradas.filter(i => i.createdAt >= desde);
                }
                
                if (fechaHasta) {
                    const hasta = new Date(fechaHasta).getTime();
                    ideasFiltradas = ideasFiltradas.filter(i => i.createdAt <= hasta);
                }
                
                if (ideasFiltradas.length === 0) {
                    alert('No hay ideas que coincidan con los filtros seleccionados.');
                    return;
                }
                
                if (formato === 'pdf') {
                    await generarPDFIdeas(ideasFiltradas);
                } else {
                    generarCSVIdeas(ideasFiltradas);
                }
            }

            async function generarPDFIdeas(ideasFiltradas) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Logo y t√≠tulo
                doc.setFontSize(24);
                doc.setTextColor(102, 126, 234);
                doc.text('crea', 20, 20);
                
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text('Reporte de Ideas', 20, 35);
                
                // Info del reporte
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                const fecha = new Date().toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                doc.text(`Generado: ${fecha}`, 20, 45);
                
                const salaNombre = filtroSala === 'todas' 
                    ? 'Todas las salas' 
                    : salas.find(s => s.id === filtroSala)?.nombre || 'Sala';
                doc.text(`Sala: ${salaNombre}`, 20, 51);
                doc.text(`Total de ideas: ${ideasFiltradas.length}`, 20, 57);
                
                // L√≠nea separadora
                doc.setDrawColor(200, 200, 200);
                doc.line(20, 62, 190, 62);
                
                // Preparar datos para la tabla
                const rows = ideasFiltradas.map(idea => {
                    const fechaIdea = new Date(idea.createdAt).toLocaleDateString('es-ES');
                    const estado = idea.estado.charAt(0).toUpperCase() + idea.estado.slice(1);
                    const reacciones = Object.keys(idea.reaccionesPorUsuario || {}).length;
                    const comentarios = (idea.comentarios || []).length;
                    
                    return [
                        idea.texto.substring(0, 60) + (idea.texto.length > 60 ? '...' : ''),
                        idea.creadorNombre || 'Usuario',
                        estado,
                        fechaIdea,
                        `${reacciones} / ${comentarios}`
                    ];
                });
                
                // Crear tabla
                doc.autoTable({
                    startY: 68,
                    head: [['Idea', 'Creador', 'Estado', 'Fecha', 'Reacciones/Coment']],
                    body: rows,
                    headStyles: {
                        fillColor: [102, 126, 234],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    margin: { top: 68, left: 20, right: 20 },
                    styles: {
                        fontSize: 9,
                        cellPadding: 5
                    },
                    columnStyles: {
                        0: { cellWidth: 65 },
                        1: { cellWidth: 32 },
                        2: { cellWidth: 28 },
                        3: { cellWidth: 28 },
                        4: { cellWidth: 32, halign: 'center' }
                    }
                });
                
                // Pie de p√°gina
                const totalPages = doc.internal.pages.length - 1;
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(
                        `P√°gina ${i} de ${totalPages} | Generado con Crea`, 
                        doc.internal.pageSize.width / 2, 
                        doc.internal.pageSize.height - 10, 
                        { align: 'center' }
                    );
                }
                
                // Descargar
                const nombreArchivo = `crea-ideas-${salaNombre.toLowerCase().replace(/\s/g, '-')}-${new Date().getTime()}.pdf`;
                doc.save(nombreArchivo);
                
                onCerrar();
            }

            function generarCSVIdeas(ideasFiltradas) {
                const datos = ideasFiltradas.map(idea => ({
                    'ID': idea.id,
                    'Texto': idea.texto,
                    'Creador': idea.creadorNombre || 'Usuario',
                    'Estado': idea.estado,
                    'Fecha Creaci√≥n': new Date(idea.createdAt).toLocaleDateString('es-ES'),
                    'Duraci√≥n (horas)': idea.duracionHoras || 0,
                    'Reacciones': Object.keys(idea.reaccionesPorUsuario || {}).length,
                    'Comentarios': (idea.comentarios || []).length,
                    'Propuestas Aceptadas': idea.propuestasAceptadas || 0,
                    'Sala': salas.find(s => s.id === idea.salaId)?.nombre || 'Desconocida'
                }));
                
                const csv = Papa.unparse(datos, {
                    quotes: true,
                    delimiter: ',',
                    header: true
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const salaNombre = filtroSala === 'todas' 
                    ? 'todas' 
                    : salas.find(s => s.id === filtroSala)?.nombre.toLowerCase().replace(/\s/g, '-') || 'sala';
                
                link.setAttribute('href', url);
                link.setAttribute('download', `crea-ideas-${salaNombre}-${new Date().getTime()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                onCerrar();
            }

            async function exportarAnalytics() {
                if (formato === 'csv') {
                    alert('Las estad√≠sticas solo se pueden exportar en formato PDF.');
                    return;
                }
                
                setCargando(true);
                
                // Calcular estad√≠sticas
                const salasSnapshot = await db.collection('salas')
                    .where(`miembros.${usuario.uid}`, '!=', null)
                    .get();
                
                const salasIds = salasSnapshot.docs.map(doc => doc.id);
                
                const colaboradoresSet = new Set();
                salasSnapshot.docs.forEach(doc => {
                    const sala = doc.data();
                    Object.keys(sala.miembros).forEach(uid => {
                        if (uid !== usuario.uid && uid !== 'anonimo') {
                            colaboradoresSet.add(uid);
                        }
                    });
                });
                
                const ideasPromises = salasIds.map(salaId =>
                    db.collection('ideas')
                        .where('salaId', '==', salaId)
                        .where('enBasurero', '==', false)
                        .get()
                );
                
                const ideasSnapshots = await Promise.all(ideasPromises);
                const todasLasIdeas = [];
                ideasSnapshots.forEach(snapshot => {
                    snapshot.docs.forEach(doc => {
                        todasLasIdeas.push({ id: doc.id, ...doc.data() });
                    });
                });
                
                const ideasPorEstado = {
                    incubando: 0,
                    activa: 0,
                    realizada: 0,
                    rechazada: 0,
                    expirada: 0
                };
                
                todasLasIdeas.forEach(idea => {
                    if (ideasPorEstado.hasOwnProperty(idea.estado)) {
                        ideasPorEstado[idea.estado]++;
                    }
                });
                
                const totalIdeas = Object.values(ideasPorEstado).reduce((a, b) => a + b, 0);
                
                await generarPDFAnalytics(colaboradoresSet.size, ideasPorEstado, totalIdeas, salasSnapshot.docs.length);
                
                setCargando(false);
                onCerrar();
            }

            async function generarPDFAnalytics(colaboradores, ideasPorEstado, totalIdeas, totalSalas) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Logo y t√≠tulo
                doc.setFontSize(24);
                doc.setTextColor(102, 126, 234);
                doc.text('crea', 20, 20);
                
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text('Reporte de Estad√≠sticas', 20, 35);
                
                // Info del reporte
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                const fecha = new Date().toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                doc.text(`Generado: ${fecha}`, 20, 45);
                doc.text(`Usuario: ${usuario.nombre}`, 20, 51);
                
                // L√≠nea separadora
                doc.setDrawColor(200, 200, 200);
                doc.line(20, 58, 190, 58);
                
                // Resumen general
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('Resumen General', 20, 70);
                
                doc.setFontSize(11);
                doc.setTextColor(60, 60, 60);
                doc.text(`‚Ä¢ Total de salas: ${totalSalas}`, 25, 80);
                doc.text(`‚Ä¢ Colaboradores activos: ${colaboradores}`, 25, 88);
                doc.text(`‚Ä¢ Ideas totales: ${totalIdeas}`, 25, 96);
                
                // Crear gr√°fico de distribuci√≥n si hay ideas
                if (totalIdeas > 0) {
                    // Crear canvas temporal para el gr√°fico
                    const canvas = document.createElement('canvas');
                    canvas.width = 400;
                    canvas.height = 300;
                    const ctx = canvas.getContext('2d');
                    
                    // Crear gr√°fico de barras horizontales
                    const chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Incubando', 'Activas', 'Realizadas', 'Rechazadas', 'Expiradas'],
                            datasets: [{
                                label: 'N√∫mero de Ideas',
                                data: [
                                    ideasPorEstado.incubando,
                                    ideasPorEstado.activa,
                                    ideasPorEstado.realizada,
                                    ideasPorEstado.rechazada,
                                    ideasPorEstado.expirada
                                ],
                                backgroundColor: [
                                    'rgba(234, 179, 8, 0.8)',   // Amarillo - Incubando
                                    'rgba(34, 197, 94, 0.8)',   // Verde - Activas
                                    'rgba(59, 130, 246, 0.8)',  // Azul - Realizadas
                                    'rgba(239, 68, 68, 0.8)',   // Rojo - Rechazadas
                                    'rgba(107, 114, 128, 0.8)'  // Gris - Expiradas
                                ],
                                borderColor: [
                                    'rgba(234, 179, 8, 1)',
                                    'rgba(34, 197, 94, 1)',
                                    'rgba(59, 130, 246, 1)',
                                    'rgba(239, 68, 68, 1)',
                                    'rgba(107, 114, 128, 1)'
                                ],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'Distribuci√≥n de Ideas por Estado',
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 20
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    },
                                    title: {
                                        display: true,
                                        text: 'Cantidad'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Estado'
                                    }
                                }
                            }
                        }
                    });
                    
                    // Esperar a que el gr√°fico se renderice
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Convertir canvas a imagen
                    const chartImage = canvas.toDataURL('image/png');
                    
                    // Agregar el gr√°fico al PDF
                    doc.addImage(chartImage, 'PNG', 15, 105, 180, 100);
                    
                    // Limpiar
                    chart.destroy();
                    canvas.remove();
                    
                    // Ajustar posici√≥n para la tabla
                    const tableStartY = 215;
                    
                    // Distribuci√≥n por estado (tabla)
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Detalle Num√©rico', 20, tableStartY);
                    
                    const estadosData = [
                        ['ü•ö Incubando', ideasPorEstado.incubando, totalIdeas > 0 ? ((ideasPorEstado.incubando / totalIdeas) * 100).toFixed(1) + '%' : '0%'],
                        ['‚ö° Activas', ideasPorEstado.activa, totalIdeas > 0 ? ((ideasPorEstado.activa / totalIdeas) * 100).toFixed(1) + '%' : '0%'],
                        ['‚úì Realizadas', ideasPorEstado.realizada, totalIdeas > 0 ? ((ideasPorEstado.realizada / totalIdeas) * 100).toFixed(1) + '%' : '0%'],
                        ['‚úó Rechazadas', ideasPorEstado.rechazada, totalIdeas > 0 ? ((ideasPorEstado.rechazada / totalIdeas) * 100).toFixed(1) + '%' : '0%'],
                        ['‚è∞ Expiradas', ideasPorEstado.expirada, totalIdeas > 0 ? ((ideasPorEstado.expirada / totalIdeas) * 100).toFixed(1) + '%' : '0%']
                    ];
                    
                    doc.autoTable({
                        startY: tableStartY + 6,
                        head: [['Estado', 'Cantidad', 'Porcentaje']],
                        body: estadosData,
                        headStyles: {
                            fillColor: [102, 126, 234],
                            textColor: [255, 255, 255],
                            fontStyle: 'bold'
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        },
                        margin: { left: 20, right: 20 },
                        styles: {
                            fontSize: 10,
                            cellPadding: 5
                        }
                    });
                    
                    // Nota al pie
                    const finalY = doc.lastAutoTable.finalY + 15;
                    doc.setFontSize(9);
                    doc.setTextColor(120, 80, 170);
                    doc.text('üí° Nota: Estas estad√≠sticas reflejan √∫nicamente la actividad actual,', 20, finalY);
                    doc.text('sin incluir m√©tricas estresantes como tasas de aprobaci√≥n.', 20, finalY + 6);
                } else {
                    // Si no hay ideas, mostrar mensaje
                    doc.setFontSize(12);
                    doc.setTextColor(150, 150, 150);
                    doc.text('No hay ideas registradas para generar gr√°ficos.', 20, 120);
                }
                
                // Pie de p√°gina
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(
                    'Generado con Crea | Brainstorming Colaborativo', 
                    doc.internal.pageSize.width / 2, 
                    doc.internal.pageSize.height - 10, 
                    { align: 'center' }
                );
                
                // Descargar
                const nombreArchivo = `crea-estadisticas-${new Date().getTime()}.pdf`;
                doc.save(nombreArchivo);
            }

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onCerrar}>
                    <div 
                        className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Header */}
                        <div className="sticky top-0 bg-white border-b p-6 flex justify-between items-center rounded-t-2xl">
                            <h2 className="text-2xl font-bold text-gray-800">üì• Exportar Datos</h2>
                            <button
                                onClick={onCerrar}
                                className="text-gray-400 hover:text-gray-600 text-2xl"
                            >
                                √ó
                            </button>
                        </div>

                        <div className="p-6 space-y-6">
                            {/* Tipo de exportaci√≥n */}
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-3">
                                    ¬øQu√© deseas exportar?
                                </label>
                                <div className="grid grid-cols-2 gap-3">
                                    <button
                                        onClick={() => setTipoExportacion('ideas')}
                                        className={`p-4 rounded-lg border-2 transition-all ${
                                            tipoExportacion === 'ideas'
                                                ? 'border-blue-500 bg-blue-50 text-blue-700'
                                                : 'border-gray-200 hover:border-gray-300'
                                        }`}
                                    >
                                        <div className="text-2xl mb-1">üí°</div>
                                        <div className="font-medium">Ideas</div>
                                        <div className="text-xs text-gray-600">Listado detallado</div>
                                    </button>
                                    <button
                                        onClick={() => setTipoExportacion('analytics')}
                                        className={`p-4 rounded-lg border-2 transition-all ${
                                            tipoExportacion === 'analytics'
                                                ? 'border-blue-500 bg-blue-50 text-blue-700'
                                                : 'border-gray-200 hover:border-gray-300'
                                        }`}
                                    >
                                        <div className="text-2xl mb-1">üìä</div>
                                        <div className="font-medium">Estad√≠sticas</div>
                                        <div className="text-xs text-gray-600">Reporte visual</div>
                                    </button>
                                </div>
                            </div>

                            {/* Formato */}
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-3">
                                    Formato
                                </label>
                                <div className="grid grid-cols-2 gap-3">
                                    <button
                                        onClick={() => setFormato('pdf')}
                                        disabled={tipoExportacion === 'analytics'}
                                        className={`p-4 rounded-lg border-2 transition-all ${
                                            formato === 'pdf'
                                                ? 'border-red-500 bg-red-50 text-red-700'
                                                : 'border-gray-200 hover:border-gray-300'
                                        } ${tipoExportacion === 'analytics' ? 'opacity-100' : ''}`}
                                    >
                                        <div className="text-2xl mb-1">üìÑ</div>
                                        <div className="font-medium">PDF</div>
                                        <div className="text-xs text-gray-600">Documento profesional</div>
                                    </button>
                                    <button
                                        onClick={() => setFormato('csv')}
                                        disabled={tipoExportacion === 'analytics'}
                                        className={`p-4 rounded-lg border-2 transition-all ${
                                            formato === 'csv'
                                                ? 'border-green-500 bg-green-50 text-green-700'
                                                : 'border-gray-200 hover:border-gray-300'
                                        } ${tipoExportacion === 'analytics' ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    >
                                        <div className="text-2xl mb-1">üìä</div>
                                        <div className="font-medium">CSV</div>
                                        <div className="text-xs text-gray-600">Para Excel/Sheets</div>
                                    </button>
                                </div>
                            </div>

                            {/* Filtros (solo para ideas) */}
                            {tipoExportacion === 'ideas' && (
                                <>
                                    <div className="border-t pt-4">
                                        <h3 className="text-sm font-bold text-gray-700 mb-3">üîç Filtros Avanzados</h3>
                                    </div>

                                    {/* Filtro por sala */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Sala
                                        </label>
                                        <select
                                            value={filtroSala}
                                            onChange={(e) => setFiltroSala(e.target.value)}
                                            className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                                        >
                                            <option value="todas">Todas las salas</option>
                                            {salas.map(sala => (
                                                <option key={sala.id} value={sala.id}>
                                                    {sala.nombre}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* Filtro por estado */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Estado
                                        </label>
                                        <select
                                            value={filtroEstado}
                                            onChange={(e) => setFiltroEstado(e.target.value)}
                                            className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                                        >
                                            <option value="todos">Todos los estados</option>
                                            <option value="incubando">ü•ö Incubando</option>
                                            <option value="activa">‚ö° Activas</option>
                                            <option value="realizada">‚úì Realizadas</option>
                                            <option value="rechazada">‚úó Rechazadas</option>
                                            <option value="expirada">‚è∞ Expiradas</option>
                                        </select>
                                    </div>

                                    {/* Filtro por fecha */}
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Desde
                                            </label>
                                            <input
                                                type="date"
                                                value={fechaDesde}
                                                onChange={(e) => setFechaDesde(e.target.value)}
                                                className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Hasta
                                            </label>
                                            <input
                                                type="date"
                                                value={fechaHasta}
                                                onChange={(e) => setFechaHasta(e.target.value)}
                                                className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                                            />
                                        </div>
                                    </div>
                                </>
                            )}

                            {/* Botones */}
                            <div className="flex gap-3 pt-4 border-t">
                                <button
                                    onClick={onCerrar}
                                    disabled={cargando}
                                    className="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium disabled:opacity-50"
                                >
                                    Cancelar
                                </button>
                                <button
                                    onClick={handleExportar}
                                    disabled={cargando}
                                    className="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-medium disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                >
                                    {cargando ? (
                                        <>
                                            <span className="animate-spin">‚è≥</span>
                                            <span>Generando...</span>
                                        </>
                                    ) : (
                                        <>
                                            <span>üì•</span>
                                            <span>Exportar</span>
                                        </>
                                    )}
                                </button>
                            </div>

                            {/* Nota informativa */}
                            <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded text-sm">
                                <p className="text-blue-800">
                                    <strong>üí° Consejo:</strong> Los archivos PDF son ideales para compartir reportes, 
                                    mientras que CSV es perfecto para an√°lisis en Excel o Google Sheets.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Modal Desaf√≠o
        function ModalDesafio({ desafio, onCerrar, onOtro }) {
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-gradient-to-br from-orange-50 to-yellow-50 rounded-2xl shadow-2xl p-8 w-full max-w-lg fade-in border-4 border-orange-300">
                        <div className="flex justify-between items-start mb-6">
                            <div className="flex-1">
                                <div className="text-4xl mb-2">üé≤</div>
                                <h2 className="text-3xl font-bold text-orange-800 mb-2">
                                    {desafio.titulo}
                                </h2>
                            </div>
                            <button
                                onClick={onCerrar}
                                className="text-orange-500 hover:text-orange-700 text-3xl font-bold"
                            >
                                √ó
                            </button>
                        </div>
                        
                        <div className="bg-white rounded-xl p-6 mb-6 shadow-md">
                            <h3 className="font-bold text-gray-800 mb-3 text-lg">üìù El Desaf√≠o:</h3>
                            <p className="text-gray-700 mb-4 text-lg leading-relaxed">
                                {desafio.descripcion}
                            </p>
                            
                            <div className="bg-orange-50 rounded-lg p-4 border-l-4 border-orange-400">
                                <h4 className="font-bold text-orange-800 mb-2">üí° Ejemplo:</h4>
                                <p className="text-gray-700 italic">
                                    "{desafio.ejemplo}"
                                </p>
                            </div>
                        </div>

                        <div className="flex gap-3">
                            <button
                                onClick={onOtro}
                                className="flex-1 bg-gradient-to-r from-orange-500 to-yellow-500 text-white py-3 px-6 rounded-xl font-bold hover:from-orange-600 hover:to-yellow-600"
                            >
                                üé≤ Otro Desaf√≠o
                            </button>
                            <button
                                onClick={onCerrar}
                                className="px-6 py-3 bg-white border-2 border-orange-300 text-orange-700 rounded-xl font-bold hover:bg-orange-50"
                            >
                                ¬°Vamos! üöÄ
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Componente Banner de Cookies
        function BannerCookies() {
            const [mostrar, setMostrar] = useState(false);

            useEffect(() => {
                // Verificar si el usuario ya acept√≥ las cookies
                const cookiesAceptadas = localStorage.getItem('cookies_aceptadas');
                if (!cookiesAceptadas) {
                    setMostrar(true);
                }
            }, []);

            function aceptarCookies() {
                localStorage.setItem('cookies_aceptadas', 'true');
                setMostrar(false);
            }

            if (!mostrar) return null;

            return (
                <div className="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-purple-200 shadow-2xl z-50 p-4 sm:p-6">
                    <div className="max-w-6xl mx-auto">
                        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                            <div className="flex-1">
                                <p className="text-gray-800 text-sm sm:text-base leading-relaxed">
                                    üç™ Usamos cookies esenciales para el funcionamiento de Crea. 
                                    Al continuar navegando, aceptas nuestra{' '}
                                    <a 
                                        href="privacidad.html" 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="text-purple-600 hover:underline font-medium"
                                    >
                                        Pol√≠tica de Privacidad
                                    </a>
                                    .
                                </p>
                            </div>
                            <button
                                onClick={aceptarCookies}
                                className="gradient-bg text-white px-6 py-2 rounded-lg font-medium hover:opacity-90 transition-opacity whitespace-nowrap"
                            >
                                Aceptar
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Componente Footer
        function Footer() {
            return (
                <footer className="bg-gray-800 text-white py-6 mt-auto">
                    <div className="max-w-6xl mx-auto px-4">
                        <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div className="text-center sm:text-left">
                                <p className="text-gray-400 text-sm">
                                    ¬© 2026 Crea - Brainstorming Colaborativo
                                </p>
                            </div>
                            <div className="flex flex-wrap justify-center gap-4 sm:gap-6 text-sm">
                                <a 
                                    href="privacidad.html" 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="text-gray-300 hover:text-purple-300 transition-colors"
                                >
                                    Privacidad
                                </a>
                                <a 
                                    href="terminos.html" 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="text-gray-300 hover:text-purple-300 transition-colors"
                                >
                                    T√©rminos
                                </a>
                                <a 
                                    href="ayuda.html" 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="text-gray-300 hover:text-purple-300 transition-colors"
                                >
                                    Ayuda
                                </a>
                                <a 
                                    href="mailto:contacto@crea-app.com"
                                    className="text-gray-300 hover:text-purple-300 transition-colors"
                                >
                                    Contacto
                                </a>
                            </div>
                        </div>
                    </div>
                </footer>
            );
        }

        // App principal con Banner y Footer
        function AppWrapper() {
            return (
                <>
                    <App />
                    <BannerCookies />
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<AppWrapper />);
    </script>
</body>
</html>